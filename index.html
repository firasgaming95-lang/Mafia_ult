<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mafia 3D - Ultimate Edition</title>

    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/dist/twemoji.min.js" crossorigin="anonymous"></script>

    <style>
        body.is-mobile .container{
    position: absolute;
    left: 50%;
    top: 8px; /* ÙŠØ¨Ø¯Ø£ Ù…Ù† Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ */
    transform: translate(-50%, 0);
    width: 100%;
    max-width: 100%;
    height: auto;
    max-height: calc(100vh - 44px); /* Ù†ØªØ±Ùƒ Ù…Ø³Ø§Ø­Ø© Ù„Ø´Ø±ÙŠØ· Ù…ÙˆØ¬Ø² Ø§Ù„Ø£Ø®Ø¨Ø§Ø± ØªØ­Øª */
    border-radius: 0;
    padding: 14px 10px 18px;
    box-shadow: none;
}


      body.is-mobile h1{
    font-size: 1.8rem;      /* Ø£ØµØºØ± Ø´ÙˆÙŠ Ø¹Ø´Ø§Ù† Ù…Ø§ ÙŠØ¶ØºØ· Ø§Ù„Ø´Ø§Ø´Ø© */
    letter-spacing: 0.5px;  /* Ù…Ø³Ø§ÙØ© Ø£Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø­Ø±ÙˆÙ */
    margin-top: 4px;
    margin-bottom: 8px;
}

body.is-mobile #info-btn,
body.is-mobile #log-btn{
    top: 18px;      /* ÙÙˆÙ‚ */
    bottom: auto;   /* Ù…Ø§ Ø¹Ø§Ø¯ ØªØ­Øª */
    width: 40px;
    height: 40px;
    font-size: 1.2rem;
}


        body.is-mobile #info-btn{
            right: 16px;
        }
        body.is-mobile #log-btn{
            left: 16px;
        }

        body.is-mobile button{
            font-size: 0.95rem;
            padding: 12px;
        }

        body.is-mobile input{
            font-size: 1rem;
            padding: 12px;
        }

        body.is-mobile .players-grid{
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        body.is-mobile .player-card{
            padding: 6px 2px;
            font-size: 0.75rem;
        }

        body.is-mobile .player-card img{
            width: 38px;
            height: 38px;
        }

        body.is-mobile #canvas-container{
            filter: blur(1px);
            opacity: 0.9;
        }

        /* Ø´Ø±ÙŠØ· ØªØ§ÙŠÙ…Ø± Ø§Ù„ØªØµÙˆÙŠØª + Ø£Ø²Ø±Ø§Ø±Ù‡ */
        #vote-timer-bar{
            margin: 10px 0 0;
            text-align: center;
            font-size: 0.95rem;
            color: #e5e7eb;
            opacity: 0.9;
        }
        #vote-timer-bar button{
            display: inline-block;
            margin-inline-start: 6px;
            padding: 3px 9px;
            font-size: 0.75rem;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.6);
            background: rgba(15,23,42,0.9);
            color: #e5e7eb;
            cursor: pointer;
        }
        #vote-timer-bar button:hover{
            background: rgba(148,163,184,0.35);
        }
        .vote-timer-finished{
            animation: voteShake 0.4s linear 3;
            color:#fca5a5;
        }
        @keyframes voteShake{
            0%{transform:translateX(0);}
            20%{transform:translateX(-2px);}
            40%{transform:translateX(2px);}
            60%{transform:translateX(-2px);}
            80%{transform:translateX(2px);}
            100%{transform:translateX(0);}
        }

        :root {
            --font-main: 'Tajawal', sans-serif;
            --bg-dark: #050308;
            --glass-bg: rgba(10, 10, 10, 0.9);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-color: #e0e0e0;

            /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø¯ÙˆØ§Ø± */
            --accent-gold: #ffd700;
            --accent-night: #00d2ff;
            --mafia-red: #ff2e63;
            --success-green: #08d9d6;
            --jester-purple: #d980fa;
            --mayor-orange: #e17055;
            --sniper-blue: #38bdf8;

            /* ØªØ¯Ø±Ø¬Ø§Øª */
            --grad-red: linear-gradient(135deg, #ff2e63, #bf1a2f);
            --grad-blue: linear-gradient(135deg, #00d2ff, #3a7bd5);
            --grad-gold: linear-gradient(135deg, #f1c40f, #b7950b);
        }

        * {
            box-sizing: border-box;
            outline: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            height: 100vh;
            overflow: hidden;
            font-family: var(--font-main);
            color: var(--text-color);
            background-color: var(--bg-dark);
        }

/* === Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© (Ø§Ù„Ø­Ø§ÙˆÙŠØ©) === */
    #canvas-container {
        position: fixed;
        inset: 0;
        z-index: -1;
        overflow: hidden;
        transition: background 0.8s ease, filter 0.8s ease; /* Ø§Ù†ØªÙ‚Ø§Ù„ Ù†Ø§Ø¹Ù… Ø¨ÙŠÙ† Ø§Ù„Ù„ÙŠÙ„ ÙˆØ§Ù„Ù†Ù‡Ø§Ø± */
        will-change: transform, filter;
    }

    /* Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù…Ø¤Ø«Ø±Ø§Øª Ø§Ù„Ø¶ÙˆØ¦ÙŠØ© (Ù†Ø¬ÙˆÙ… Ø£Ùˆ Ø£Ø´Ø¹Ø© Ø´Ù…Ø³) */
    #canvas-container::before {
        content: "";
        position: absolute;
        inset: -40px;
        pointer-events: none;
        transition: opacity 0.8s ease;
    }

    /* ============================
       ğŸŒ‘ ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ (Dark Mode)
       ============================ */
    body.is-night #canvas-container {
        /* Ø®Ù„ÙÙŠØ© Ù…Ø¸Ù„Ù…Ø© (Ø¨Ù†ÙØ³Ø¬ÙŠ ØºØ§Ù…Ù‚ ÙˆØ£Ø³ÙˆØ¯) */
        background: radial-gradient(circle at 15% -10%, #3a1c71 0, #0b0510 40%, #020308 80%);
    }

    body.is-night #canvas-container::before {
        /* Ù†Ø¬ÙˆÙ… Ø®Ø§ÙØªØ© ÙˆÙ„Ù…Ø¹Ø§Ù† Ø¨Ø³ÙŠØ· */
        background-image:
            radial-gradient(circle at 10% 20%, rgba(255,255,255,0.06) 0, transparent 60%),
            radial-gradient(circle at 80% 0%, rgba(255,0,90,0.14) 0, transparent 55%),
            radial-gradient(circle at 0% 100%, rgba(0,210,255,0.12) 0, transparent 55%);
        opacity: 0.6;
    }

    /* ============================
       â˜€ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø± (Light Mode)
       ============================ */
    body.is-day #canvas-container {
        /* Ø§Ù„ÙØ±Ù‚ Ø§Ù„ÙˆØ­ÙŠØ¯: Ø®Ù„ÙÙŠØ© Ø³Ù…Ø§ÙˆÙŠØ©/Ø²Ø±Ù‚Ø§Ø¡ ØªÙ…Ø«Ù„ Ø¶ÙˆØ¡ Ø§Ù„Ù†Ù‡Ø§Ø± */
        background: radial-gradient(circle at 50% -20%, #93c5fd 0, #3b82f6 30%, #172554 75%, #020617 100%);
    }

    body.is-day #canvas-container::before {
        /* Ø£Ø´Ø¹Ø© Ø´Ù…Ø³ Ø³Ø§Ø·Ø¹Ø© Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ */
        background-image:
            radial-gradient(circle at 50% -10%, rgba(255, 255, 255, 0.5) 0, transparent 40%), /* Ù‚Ø±Øµ Ø§Ù„Ø´Ù…Ø³ */
            radial-gradient(circle at 90% 10%, rgba(255, 255, 255, 0.2) 0, transparent 50%);  /* ÙˆÙ‡Ø¬ Ø¬Ø§Ù†Ø¨ÙŠ */
        opacity: 0.85;
    }

    /* ØªØ­Ø³ÙŠÙ† Ø±Ø¤ÙŠØ© Ø§Ù„ÙƒØ±ÙˆØª ÙÙŠ Ø§Ù„Ù†Ù‡Ø§Ø± (Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØªØ¨Ø§ÙŠÙ† Ù„Ø£Ù† Ø§Ù„Ø®Ù„ÙÙŠØ© ÙØ§ØªØ­Ø©) */
    body.is-day .char-card-inner {
        box-shadow: 0 25px 50px rgba(0,0,0,0.85); /* Ø¸Ù„ Ø£Ù‚ÙˆÙ‰ */
        border: 1px solid rgba(255,255,255,0.4);   /* Ø­Ø¯ÙˆØ¯ Ø£ÙˆØ¶Ø­ */
        background: linear-gradient(145deg, rgba(0,0,0,0.85), rgba(0,0,0,0.6)); /* ØªØºÙ…ÙŠÙ‚ Ø®Ù„ÙÙŠØ© Ø§Ù„ÙƒØ±Øª Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
    }
        /* ÙƒØ±ÙˆØª Ø§Ù„Ø´Ø®ØµÙŠØ§Øª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© â€” 3D + Ø±ÙˆÙ„ÙŠØª Ù…Ù† ÙÙˆÙ‚ Ù„ØªØ­Øª */
        .char-card-bg {
            --px: px;
            --py: 0px;
            position: absolute;
            width: 210px;
            height: 260px;
            transform-origin: center;
            transform: translate3d(var(--px), var(--py), 0) rotate(var(--r, 0deg));
            transition: transform -0.08s ease-out;
            pointer-events: none;
            perspective: 700px; /* Ù„Ù„Ù€ 3D */
        }

        /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„ÙƒØ±Øª â€“ Ù‡Ù†Ø§ Ø§Ù„Ø´ÙƒÙ„ + 3D + Ø§Ù„Ø±ÙˆÙ„ÙŠØª */
        .char-card-inner{
            width: 100%;
            height: 100%;
            border-radius: 26px;
            background: linear-gradient(145deg, rgba(0,0,0,0.9), rgba(0,0,0,0.55));
            border: 1px solid rgba(255,255,255,0.12);
            box-shadow: 0 14px 30px rgba(0,0,0,0.75);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding: 16px;
            gap: 30px;
            color: #ffffff;
            opacity: 0.6;          /* Ø´ÙØ§ÙÙŠØ© Ù‚Ù„ÙŠÙ„Ø© Ø¹Ø´Ø§Ù† Ø§Ù„Ø®Ù„ÙÙŠØ© ØªØ¨ÙŠÙ† */
            transform-origin: center;
            transform: rotateX(20deg) translateY(-130vh);
            animation: cardDrop 28s linear infinite;
        }

        /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø±ÙˆÙ„ÙŠØª Ù…Ù† ÙÙˆÙ‚ Ù„ØªØ­Øª â€“ Ø¨Ø¯ÙˆÙ† ÙØ±Ø§ØºØ§Øª ÙƒØ¨ÙŠØ±Ø© */
        @keyframes cardDrop {
            0%   { transform: rotateX(20deg) translateY(-120vh); }
            100% { transform: rotateX(20deg) translateY(120vh); }
        }

        /* ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªØ£Ø®ÙŠØ± Ø¨ÙŠÙ† Ø§Ù„ÙƒØ±ÙˆØª Ø¹Ø´Ø§Ù† ØªØ­Ø³Ù‡Ø§ Ø±ÙˆÙ„ÙŠØª Ù…ØªØªØ§Ø¨Ø¹Ø© Ø¨Ø¯ÙˆÙ† ÙØ±Ø§ØºØ§Øª ÙƒØ¨ÙŠØ±Ø© */
        .char-mafia  .char-card-inner { animation-delay: 0s; }
        .char-doc    .char-card-inner { animation-delay: -3s; }
        .char-det    .char-card-inner { animation-delay: -6s; }
        .char-mayor  .char-card-inner { animation-delay: -9s; }
        .char-jester .char-card-inner { animation-delay: -12s; }
        .char-sniper .char-card-inner { animation-delay: -15s; }
        .char-citizen .char-card-inner{ animation-delay: -18s; }

        /* Ø´ÙƒÙ„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙˆØ§Ù„Ù†ØµÙˆØµ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ±Øª */
        .char-card-bg .char-icon {
            font-size: 3.1rem;
            margin-bottom: 8px;
        }
        .char-card-bg .char-label {
            font-size: 0.9rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            opacity: 0.95;
        }
        .char-card-bg .char-sub {
            font-size: 0.75rem;
            opacity: 0.75;
        }

        /* Ø§Ù„Ù…Ø§ÙÙŠØ§ - Ø£Ø¹Ù„Ù‰ ÙŠØ³Ø§Ø± */
        .char-mafia {
            left: 8%;
            top: 8%;
            border-color: rgba(255,46,99,0.6);
        }
        .char-mafia .char-card-inner{
            border-color: rgba(255,46,99,0.6);
            background: radial-gradient(circle at 20% 0%, rgba(255,46,99,0.32), rgba(0,0,0,0.96));
        }

        /* Ø§Ù„Ø·Ø¨ÙŠØ¨ - Ø£Ø¹Ù„Ù‰ ÙŠÙ…ÙŠÙ† */
        .char-doc {
            right: 8%;
            top: 8%;
        }
        .char-doc .char-card-inner{
            border-color: rgba(8,217,214,0.6);
            background: radial-gradient(circle at 10% 0%, rgba(8,217,214,0.3), rgba(0,0,0,0.96));
        }

        /* Ø§Ù„Ù…Ø­Ù‚Ù‚ - Ø£Ø³ÙÙ„ ÙŠØ³Ø§Ø± */
        .char-det {
            left: 8%;
            bottom: 8%;
        }
        .char-det .char-card-inner{
            border-color: rgba(241,196,15,0.6);
            background: radial-gradient(circle at 0% 0%, rgba(241,196,15,0.3), rgba(0,0,0,0.96));
        }

        /* Ø§Ù„Ø¹Ù…Ø¯Ø© - Ø£Ø³ÙÙ„ ÙŠÙ…ÙŠÙ† */
        .char-mayor {
            right: 8%;
            bottom: 8%;
        }
        .char-mayor .char-card-inner{
            border-color: rgba(225,112,85,0.7);
            background: radial-gradient(circle at 100% 0%, rgba(225,112,85,0.34), rgba(0,0,0,0.96));
        }

        /* Ø§Ù„Ù…Ù‡Ø±Ø¬ - Ø£Ø¹Ù„Ù‰ Ù…Ù†ØªØµÙ */
        .char-jester {
            left: 10%;
            top: 10%;
            transform: translateX(-50%);
        }
        .char-jester .char-card-inner{
            border-color: rgba(217,128,250,0.7);
            background: radial-gradient(circle at 50% 0%, rgba(217,128,250,0.35), rgba(0,0,0,0.96));
        }

        /* Ø§Ù„Ù‚Ù†Ù‘Ø§Øµ - Ù…Ù†ØªØµÙ ÙŠÙ…ÙŠÙ† Ø´ÙˆÙŠ */
        .char-sniper {
            right: 18%;
            top: 40%;
        }
        .char-sniper .char-card-inner{
            border-color: rgba(56,189,248,0.7);
            background: radial-gradient(circle at 50% 0%, rgba(56,189,248,0.35), rgba(0,0,0,0.96));
        }

        /* Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ† - Ø£Ø³ÙÙ„ Ù…Ù†ØªØµÙ */
        .char-citizen {
            left: 79%;
            bottom: 4%;
            transform: translateX(-50%);
            width: 230px;
            height: 250px;
        }
        .char-citizen .char-card-inner{
            border-radius: 30px;
            border-color: rgba(0,210,255,0.5);
            background: linear-gradient(145deg, rgba(0,0,0,0.9), rgba(0,210,255,0.18));
        }

        .char-citizen .char-icon {
            font-size: 2.4rem;
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø²ÙˆØ§ÙŠØ§ */
        .corner-btn {
            position: fixed;
            top: 20px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(148, 163, 184, 0.8);
            color: #e5e7eb;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 0 15px rgba(0,0,0,0.7);
            transition: 0.25s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .corner-btn:hover {
            background: var(--accent-gold);
            color: #000;
            transform: translateY(-2px) scale(1.06);
            border-color: var(--accent-gold);
        }

        #info-btn { right: 20px; font-family: serif; }
        #log-btn { left: 20px; font-size: 1.2rem; }

        /* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .container {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 95%;
            max-width: 480px;
            max-height: 85vh;
            overflow-y: auto;
            scrollbar-width: 100 ;

            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 25px;
            box-shadow: 0 16px 40px rgba(0,0,0,0.8);
            animation: slideIn 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .container::-webkit-scrollbar { display: none; }

        @keyframes slideIn {
            from { opacity: 0; transform: translate(-50%, -46%); }
            to   { opacity: 1; transform: translate(-50%, -50%); }
        }
   
        .made-by-tag{
    text-align: right;
    font-size: 0.8rem;
    color: #9ca3af;
    opacity: 0.85;
    margin-bottom: 4px;
}

/* Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ Ù†Ø®Ù„ÙŠÙ‡Ø§ Ø£ØµØºØ± Ø´ÙˆÙŠ */
body.is-mobile .made-by-tag{
    font-size: 0.75rem;
}

        h1 {
            text-align: center;
            font-size: 2.6rem;
            margin-bottom: 20px;
            font-weight: 900;
            letter-spacing: 3px;
            background: linear-gradient(to bottom, #fff, #bbb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 10px 20px rgba(0,0,0,0.5);
            margin-top: 5px;
        }

        h2, h3 { color: #fff; font-weight: 700; margin-top: 0; }

        input {
            width: 100%; padding: 16px;
            background: rgba(0,0,0,0.4);
            border: 2px solid rgba(255,255,255,0.05);
            border-radius: 12px; color: #fff;
            font-family: var(--font-main); font-size: 1.1rem; text-align: center;
            margin-bottom: 15px; transition: 0.3s;
        }
        input:focus {
            border-color: var(--accent-night);
            background: rgba(0,0,0,0.6);
            box-shadow: 0 0 12px rgba(0, 210, 255, 0.35);
        }

        button {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            font-family: var(--font-main); font-size: 1.1rem; font-weight: 900;
            cursor: pointer; background: var(--grad-blue);
            color: #fff; margin-bottom: 12px; transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: relative; overflow: hidden;
        }
        button:active { transform: scale(0.98); }
        button:disabled { background: #444; opacity: 0.6; cursor: not-allowed; box-shadow: none; }

        .btn-red { background: var(--grad-red); box-shadow: 0 5px 18px rgba(255, 46, 99, 0.4); }
        .btn-green { background: linear-gradient(135deg, #08d9d6, #11998e); box-shadow: 0 5px 18px rgba(8, 217, 214, 0.4); }
        .btn-outline {
            background: transparent;
            border: 2px solid rgba(255,255,255,0.15);
            box-shadow: none;
            color: rgba(255,255,255,0.7);
        }
        .btn-outline:hover {
            border-color: #fff;
            color: #fff;
            background: rgba(255,255,255,0.05);
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(75px, 1fr));
            gap: 8px;
            margin: 20px 0;
        }

        .player-card {
            background: rgba(15,23,42,0.7);
            border: 1px solid rgba(148,163,184,0.45);
            padding: 8px 4px; border-radius: 14px; text-align: center; cursor: pointer;
            transition: all 0.25s; position: relative; font-size: 0.8rem;
            display: flex; flex-direction: column; align-items: center;
        }
        .player-card img {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            margin-bottom: 5px;
            border: 2px solid rgba(248,250,252,0.9);
            background: radial-gradient(circle at 30% 0, #1f2933, #020617);
            box-shadow: 0 6px 14px rgba(0,0,0,0.9);
        }
        .player-card:hover {
            background: rgba(30,64,175,0.9);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(15,23,42,0.9);
        }
        .player-card.selected {
            background: radial-gradient(circle at 0 0, rgba(255,46,99,0.3), rgba(15,23,42,0.95));
            border: 2px solid var(--mafia-red);
            box-shadow: 0 0 14px var(--mafia-red);
            transform: translateY(-2px) scale(1.04);
        }
        .player-card.dead {
            opacity: 0.35;
            filter: grayscale(100%);
            text-decoration: line-through;
            pointer-events: none;
            background: #000;
        }

        .card-box {
            background: rgba(0,0,0,0.4);
            padding: 15px;
            border-radius: 16px;
            margin: 15px 0;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .role-input-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .name-tag {
            display: inline-flex; align-items: center; background: rgba(15,23,42,0.9);
            padding: 4px 10px; border-radius: 50px; margin: 4px; font-size: 0.85rem;
            border: 1px solid rgba(148,163,184,0.7);
        }

        /* Avatar Selection Styles */
        .avatar-selection-grid {
            display: flex;
            justify-content: center;
            gap: 14px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .avatar-option {
            width: 84px;
            height: 84px;
            border-radius: 50%;
            border: 0;
            cursor: pointer;
            transition: 0.25s;
            background-color: #020617;
            box-shadow:
                0 0 0 3px rgba(15,23,42,1),
                0 0 0 5px rgba(148,163,184,0.6),
                0 14px 30px rgba(0,0,0,1);
            padding: 0;
            object-fit: cover;
        }
        .avatar-option:hover {
            transform: translateY(-4px) scale(1.03);
            box-shadow:
                0 0 0 3px rgba(59,130,246,1),
                0 0 0 6px rgba(56,189,248,0.9),
                0 18px 38px rgba(15,23,42,1);
        }
        .avatar-option.selected {
            transform: translateY(-3px) scale(1.06);
            box-shadow:
                0 0 0 3px rgba(8,217,214,1),
                0 0 0 7px rgba(8,217,214,0.8),
                0 20px 40px rgba(8,47,73,1);
        }
        .saved-avatar-option{
            box-shadow:
                0 0 0 3px rgba(250,204,21,0.95),
                0 0 0 6px rgba(234,179,8,0.85),
                0 18px 38px rgba(15,23,42,1);
        }

        .refresh-btn {
            font-size: 0.9rem;
            padding: 8px 15px;
            width: auto;
            display: inline-block;
            background: rgba(255,255,255,0.1);
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .refresh-btn:hover { background: rgba(255,255,255,0.2); }

        /* Flip Card Styles */
        .flip-card {
            background-color: transparent;
            width: 100%;
            height: 320px;
            perspective: 1000px;
            margin: 20px 0;
        }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }
        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .flip-card-front {
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01));
        }
        .flip-card-back {
            background: #151515;
            transform: rotateY(180deg);
            border: 2px solid var(--accent-gold);
        }

        #role-text {
            font-size: 3rem; margin: 10px 0; font-weight: 900;
            text-shadow: 0 0 30px currentColor; letter-spacing: -2px;
        }
        #phase-title {
            text-transform: uppercase; letter-spacing: 2px;
            border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px;
            color: var(--accent-gold);
        }

        /* Modals */
        #custom-modal-overlay, #rules-modal-overlay, #log-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #custom-modal-overlay.active, #rules-modal-overlay.active, #log-modal-overlay.active { opacity: 1; pointer-events: all; }

        .custom-modal {
            background: #121212; border: 1px solid #333;
            padding: 30px; border-radius: 20px; text-align: center;
            width: 90%; max-width: 380px;
            box-shadow: 0 20px 60px rgba(0,0,0,1);
            transform: scale(0.9); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 80vh; overflow-y: auto;
        }
        #custom-modal-overlay.active .custom-modal,
        #rules-modal-overlay.active .custom-modal,
        #log-modal-overlay.active .custom-modal { transform: scale(1); }

        .modal-type-error { border-color: var(--mafia-red); }
        .modal-type-success { border-color: var(--success-green); }

        .rules-content, .log-content { text-align: right; line-height: 1.6; }
        .rule-item, .log-item { margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .rule-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; display: block; }
        .log-item { font-size: 0.95rem; color: #ccc; }
        .log-time { font-size: 0.8rem; color: var(--accent-gold); margin-left: 5px; }

        /* Ø£ÙˆÙØ±Ù„Ø§ÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨ÙŠÙ† Ø§Ù„ØºØ±Ù */
        #room-transition-overlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at 50% -10%, rgba(255,255,255,0.08), rgba(0,0,0,0.96));
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.35s ease;
        }
        #room-transition-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .room-panel {
            background: rgba(5,5,10,0.95);
            border-radius: 24px;
            padding: 24px 30px;
            border: 1px solid rgba(255,255,255,0.16);
            box-shadow: 0 18px 40px rgba(0,0,0,0.9);
            text-align: center;
            transform: translateY(10px) scale(0.96);
            opacity: 0;
            transition: transform 0.35s ease, opacity 0.35s ease;
        }
        #room-transition-overlay.active .room-panel {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        .room-panel-icon {
            font-size: 2.4rem;
            margin-bottom: 10px;
        }
        .room-panel-title {
            font-size: 1.4rem;
            margin-bottom: 6px;
            color: #fff;
        }
        .room-panel-sub {
            font-size: 0.9rem;
            color: #aaa;
        }

        .hidden { display: none !important; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ù…ÙŠÙ„Ø© */
        .end-banner {
            position: relative;
            margin-top: 20px;
            border-radius: 20px;
            padding: 18px 14px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 18px 40px rgba(0,0,0,0.85);
            background: radial-gradient(circle at 0 0, rgba(255,255,255,0.06), rgba(0,0,0,0.98));
            animation: popEnd 0.5s ease-out;
            overflow: hidden;
        }
        .end-banner__icon {
            font-size: 3rem;
            margin-bottom: 8px;
        }
        .end-banner__title {
            font-size: 1.8rem;
            margin-bottom: 6px;
            font-weight: 900;
            letter-spacing: 1px;
        }
        .end-banner__text {
            font-size: 0.95rem;
            opacity: 0.9;
        }
        .end-banner--citizen {
            border-color: #08d9d6;
            background: radial-gradient(circle at 0 0, rgba(8,217,214,0.35), rgba(0,0,0,0.97));
        }
        .end-banner--citizen .end-banner__title { color: #08d9d6; }

        .end-banner--citizen::before {
            content:"";
            position:absolute;
            inset:-20px;
            background-image:
                radial-gradient(circle at 10% 0%, rgba(59,130,246,0.8) 0, transparent 50%),
                radial-gradient(circle at 90% 10%, rgba(52,211,153,0.8) 0, transparent 55%),
                radial-gradient(circle at 50% 100%, rgba(249,250,251,0.95) 0, transparent 60%);
            opacity:0.12;
            pointer-events:none;
            animation: citizenGlow 3.5s ease-in-out infinite alternate;
        }

        .end-banner--mafia {
            border-color: #ff2e63;
            background: radial-gradient(circle at 100% 0, rgba(255,46,99,0.4), rgba(0,0,0,0.97));
        }
        .end-banner--mafia .end-banner__title { color: #ff2e63; }

        .end-banner--jester {
            border-color: #d980fa;
            background: radial-gradient(circle at 50% 0, rgba(217,128,250,0.4), rgba(0,0,0,0.97));
            animation: jesterHue 3s linear infinite;
        }
        .end-banner--jester .end-banner__title { color: #d980fa; }

        .end-banner--jester::before {
            content:"";
            position:absolute;
            inset:-10px;
            background-image: repeating-linear-gradient(
                90deg,
                rgba(255,255,255,0.12),
                rgba(255,255,255,0.12) 1px,
                transparent 1px,
                transparent 4px
            );
            mix-blend-mode: screen;
            opacity:0.08;
            pointer-events:none;
            animation: jesterGlitch 0.4s steps(2,end) infinite;
        }

        @keyframes popEnd {
            from { opacity: 0; transform: translateY(10px) scale(0.96); }
            to   { opacity: 1; transform: translateY(0) scale(1); }
        }

        @keyframes citizenGlow {
            from { opacity:0.08; transform: translateY(4px); }
            to   { opacity:0.18; transform: translateY(0); }
        }

        @keyframes jesterHue {
            0%,100% { filter:hue-rotate(0deg); }
            50% { filter:hue-rotate(20deg); }
        }
        @keyframes jesterGlitch {
            0% { transform: translateX(0); }
            50% { transform: translateX(-2px); }
            100% { transform: translateX(0); }
        }

        /* ØªØ§ÙŠÙ…Ø± Ø§Ù„Ù…Ø­Ø§ÙƒÙ…Ø© (Ø¯Ø§Ø¦Ø±ÙŠ Ø­ÙˆÙ„ Ø§Ù„ØµÙˆØ±Ø©) */
        .defense-avatar-wrap {
            display:flex;
            justify-content:center;
            margin: 15px 0;
        }
        .defense-timer {
            --timer-progress: 1;
            --timer-color: #22c55e;
            width: 110px;
            height: 110px;
            border-radius: 50%;
            padding: 4px;
            background:
                conic-gradient(var(--timer-color) calc(var(--timer-progress)*360deg),
                               rgba(15,23,42,0.95) 0);
            display:flex;
            align-items:center;
            justify-content:center;
            box-shadow: 0 12px 30px rgba(0,0,0,0.9);
        }
        .defense-timer img {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            border: 3px solid rgba(15,23,42,0.9);
            background:#1a1a1a;
            box-shadow:0 6px 16px rgba(0,0,0,0.8);
        }
        .defense-timer-label {
            font-size:0.9rem;
            color:#e5e7eb;
            opacity:0.85;
            margin-bottom:8px;
        }

        /* Role mood visuals */
        body.role-mafia #action-role-title,
        body.role-mafia #turn-player-avatar {
            animation: pulseRed 1.1s ease-in-out infinite alternate;
        }
        body.role-doc #action-role-title,
        body.role-doc #turn-player-avatar {
            animation: pulseGreen 1.3s ease-in-out infinite alternate;
        }
        body.role-det #action-role-title,
        body.role-det #turn-player-avatar {
            animation: pulseYellow 1.3s ease-in-out infinite alternate;
        }
        body.role-mayor #action-role-title {
            text-shadow: 0 0 12px rgba(250,204,21,0.8);
        }
        body.role-jester #action-role-title {
            animation: glitchText 0.28s infinite;
        }
        body.role-citizen #action-role-title {
            text-shadow: 0 0 9px rgba(59,130,246,0.7);
        }
        body.role-day #action-role-title {
            text-shadow: 0 0 10px rgba(251,191,36,0.7);
        }

        @keyframes pulseRed {
            0% { text-shadow:0 0 0 rgba(248,113,113,0.0); transform:translateY(0); }
            50%{ text-shadow:0 0 18px rgba(248,113,113,0.9); transform:translateY(-1px); }
            100% { text-shadow:0 0 4px rgba(248,113,113,0.6); transform:translateY(0); }
        }
        @keyframes pulseGreen {
            0% { text-shadow:0 0 0 rgba(45,212,191,0.0); transform:translateY(0); }
            50%{ text-shadow:0 0 18px rgba(45,212,191,0.9); transform:translateY(-1px); }
            100% { text-shadow:0 0 4px rgba(45,212,191,0.6); transform:translateY(0); }
        }
        @keyframes pulseYellow {
            0% { text-shadow:0 0 0 rgba(250,204,21,0.0); transform:translateY(0); }
            50%{ text-shadow:0 0 18px rgba(250,204,21,0.9); transform:translateY(-1px); }
            100% { text-shadow:0 0 4px rgba(250,204,21,0.6); transform:translateY(0); }
        }
        @keyframes glitchText {
            0% { transform: translate(0,0); text-shadow: 1px 0 rgba(236,72,153,0.7), -1px 0 rgba(56,189,248,0.7); }
            20%{ transform: translate(-1px,1px); text-shadow: -1px 0 rgba(236,72,153,0.8), 1px 0 rgba(56,189,248,0.8); }
            40%{ transform: translate(1px,-1px); }
            60%{ transform: translate(-1px,-1px); }
            80%{ transform: translate(1px,1px); }
            100%{ transform: translate(0,0); }
        }

        /* --- Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù„Ø£Ø­Ø¯Ø§Ø« --- */
        .switch-container {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.05); padding: 12px;
            border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1);
        }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 20px; width: 20px;
            left: 3px; bottom: 3px; background-color: white;
            transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--success-green); }
        input:checked + .slider:before { transform: translateX(23px); }

        /* --- Ø¨Ø§Ù†Ø± Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ --- */
        #event-banner {
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.15), transparent);
            color: #ffeaa7; text-align: center; padding: 10px;
            margin-bottom: 15px; border-radius: 8px; border: 1px solid rgba(255, 215, 0, 0.3);
            font-size: 0.95rem; animation: slideIn 0.5s; display: none;
        }

        /* --- Ø²Ø± Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ„ (Anti-Peek) --- */
        .hold-btn {
            position: relative; overflow: hidden;
            background: #333; color: #fff;
            transition: transform 0.1s;
            user-select: none; -webkit-user-select: none;
        }
        .hold-btn:active { transform: scale(0.96); }
        .hold-btn .fill-bar {
            position: absolute; top: 0; right: 0; bottom: 0; left: 0;
            background: var(--success-green);
            width: 0%; opacity: 0.5;
            transition: width 0s;
            pointer-events: none;
        }
        .hold-btn.holding .fill-bar {
            width: 100%;
            transition: width 1.5s linear;
        }
        .hold-btn,
        .hold-btn * {
            -webkit-user-select: none;
            user-select: none;
            touch-action: none;
        }

        /* === Ø´Ø±ÙŠØ· Ù…ÙˆØ¬Ø² Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ù…ØªØ­Ø±Ù‘Ùƒ Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø© === */
      /* === Ø´Ø±ÙŠØ· Ù…ÙˆØ¬Ø² Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ù…ØªØ­Ø±Ù‘Ùƒ Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø© === */
/* === Ø´Ø±ÙŠØ· Ù…ÙˆØ¬Ø² Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ù…ØªØ­Ø±Ù‘Ùƒ Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø© === */
/* === Ø´Ø±ÙŠØ· Ù…ÙˆØ¬Ø² Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ù…ØªØ­Ø±Ù‘Ùƒ Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø© === */
/* === Ø´Ø±ÙŠØ· Ù…ÙˆØ¬Ø² Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ù…ØªØ­Ø±Ù‘Ùƒ === */
#news-ticker {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 40px;
    background: #020617;
    border-top: 1px solid rgba(148, 163, 184, 0.5);
    display: flex;
    align-items: center;
    padding: 0;
    z-index: 2000;
    overflow: hidden;
}

/* Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø«Ø§Ø¨Øª ÙŠÙ…ÙŠÙ† Ø§Ù„Ø´Ø§Ø´Ø© */
#news-ticker-label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 700;
    white-space: nowrap;
    padding: 0 15px;
    height: 100%;
    background: #0f172a;
    border-left: 2px solid var(--accent-gold);
    color: #e5e7eb;
    position: relative;
    z-index: 20; /* Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ù…ØªØ­Ø±Ùƒ */
    box-shadow: 5px 0 15px rgba(0,0,0,0.8);
    direction: rtl; /* Ù„Ø¶Ù…Ø§Ù† Ø§ØªØ¬Ø§Ù‡ Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø¨Ø± */
}

/* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªÙŠ ØªØ­Ù…Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ù…ØªØ­Ø±Ùƒ */
/* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© Ù„Ù„Ø´Ø±ÙŠØ· */
#news-ticker-marquee {
    flex: 1;
    overflow: hidden;
    height: 100%;
    position: relative;
    /* Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ø§Ù‹: Ù†Ø¬Ø¹Ù„ Ø§Ù„Ø­Ø§ÙˆÙŠØ© LTR Ø¹Ø´Ø§Ù† Ù„Ù…Ø§ Ù†Ø­Ø±Ùƒ Ù„Ù„ÙŠØ³Ø§Ø± Ù†Ø³ØªØ®Ø¯Ù… Ù‚ÙŠÙ… Ø³Ø§Ù„Ø¨Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ */
    direction: ltr; 
    display: flex;
    align-items: center;
}

/* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ø§Ù„Ù„ÙŠ ÙÙŠÙ‡Ø§ Ø§Ù„Ù†ØµÙŠÙ† */
#news-ticker-content {
    display: flex;
    flex-direction: row; /* Ø§Ù„Ù†ØµÙŠÙ† Ø¬Ù†Ø¨ Ø¨Ø¹Ø¶ */
    width: max-content;
    will-change: transform;
    /* Ø§Ù„Ø­Ø±ÙƒØ©: Ù…Ù† 0 Ø¥Ù„Ù‰ -50% (Ù†Øµ ÙˆØ§Ø­Ø¯) Ø«Ù… ÙŠØ¹ÙŠØ¯ Ù†ÙØ³Ù‡ */
    animation: moveLeft linear infinite;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ù‚Ø·Ø¹Ø© Ø§Ù„Ù†Øµ Ø§Ù„ÙˆØ§Ø­Ø¯Ø© */
.ticker-segment {
    display: flex;
    align-items: center;
    white-space: nowrap;
    /* Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù‡ÙŠ Ø§Ù„ÙØ±Ø§Øº Ø¨ÙŠÙ† Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø®Ø¨Ø± ÙˆØ¨Ø¯Ø§ÙŠØ© Ø¥Ø¹Ø§Ø¯ØªÙ‡ */
    padding-right: 100px; 
    /* Ù†Ø¹ÙŠØ¯ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù†Øµ Ù„Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¹Ø´Ø§Ù† Ø§Ù„ÙƒÙ„Ø§Ù… Ù…Ø§ ÙŠÙ†Ù‚Ù„Ø¨ */
    direction: rtl;
}

.ticker-item {
    display: inline-block;
    padding: 0 10px;
}

/* ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø­Ø±ÙƒØ©: ØªØ­Ø±ÙŠÙƒ Ù„Ù„ÙŠØ³Ø§Ø± */
@keyframes moveLeft {
    0% {
        transform: translate3d(0, 0, 0);
    }
    100% {
        /* ÙŠØªØ­Ø±Ùƒ Ø¨Ù…Ù‚Ø¯Ø§Ø± Ø¹Ø±Ø¶ Ù†Ø³Ø®Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø§Ù„Ø¶Ø¨Ø· */
        transform: translate3d(-50%, 0, 0);
    }
}

body.is-mobile #news-ticker {
    height: 36px;
    font-size: 0.75rem;
}
body.is-mobile #news-ticker {
    height: 36px;
    font-size: 0.75rem;
}

/* Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙŠÙƒÙˆÙ† Ù…Ø±ÙÙˆØ¹ Ù„ÙÙˆÙ‚ ÙˆÙ…ØºØ·ÙŠ Ø£ØºÙ„Ø¨ Ø§Ù„Ø´Ø§Ø´Ø© */
body.is-mobile #log-modal-overlay{
    align-items: flex-start;
    padding-top: 50px; /* ÙŠØ±ÙØ¹Ù‡ Ø´ÙˆÙŠ Ù„ØªØ­Øª Ù…Ù† Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© */
}

body.is-mobile #log-modal-overlay .custom-modal{
    width: 100%;
    max-width: 100%;
    height: calc(100vh - 50px);
    max-height: calc(100vh - 50px);
    border-radius: 0;
    padding: 20px 16px 24px;
}

body.is-mobile #game-log-list{
    max-height: calc(100vh - 140px);
    overflow-y: auto;
}

/* Ù†ÙØ³ Ø§Ù„ÙÙƒØ±Ø© Ù„Ù†Ø§ÙØ°Ø© Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© */
body.is-mobile #rules-modal-overlay{
    align-items: flex-start;
    padding-top: 40px;
}

body.is-mobile #rules-modal-overlay .custom-modal{
    width: 100%;
    max-width: 100%;
    height: calc(100vh - 40px);
    max-height: calc(100vh - 40px);
    border-radius: 0;
    padding: 20px 16px 24px;
}

    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "firebase/": "https://aistudiocdn.com/firebase@^12.6.0/"
  }
}
</script>
</head>
<body>
<div id="root"></div>

<button id="info-btn" class="corner-btn" onclick="openRules()">!</button>
<button id="log-btn" class="corner-btn" onclick="openLogs()">ğŸ“œ</button>

<div id="rules-modal-overlay">
    <div class="custom-modal" style="border-color: var(--accent-gold);">
        <h2 style="color: var(--accent-gold); margin-bottom: 20px;">ğŸ“œ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
        <div class="rules-content">
            <div class="rule-item">
                <span class="rule-title" style="color: var(--mafia-red);">ğŸ˜ˆ Ø§Ù„Ù…Ø§ÙÙŠØ§</span>
                ÙŠØ³ØªÙŠÙ‚Ø¸ÙˆÙ† ÙÙŠ Ø§Ù„Ù„ÙŠÙ„ Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¶Ø­ÙŠØ© ÙˆÙ‚ØªÙ„Ù‡Ø§.
            </div>

            <div class="rule-item">
                <span class="rule-title" style="color: var(--mayor-orange);">ğŸ© Ø§Ù„Ø¹Ù…Ø¯Ø©</span>
                Ù…ÙˆØ§Ø·Ù† Ø°Ùˆ Ù†ÙÙˆØ°! ØµÙˆØªÙ‡ ÙÙŠ Ø§Ù„Ù†Ù‡Ø§Ø± ÙŠØ­Ø³Ø¨ <b>Ø¨ØµÙˆØªÙŠÙ†</b>.
            </div>

            <div class="rule-item">
                <span class="rule-title" style="color: var(--success-green);">ğŸ©º Ø§Ù„Ø·Ø¨ÙŠØ¨</span>
                ÙŠØ³ØªÙŠÙ‚Ø¸ ÙÙŠ Ø§Ù„Ù„ÙŠÙ„ Ù„Ø­Ù…Ø§ÙŠØ© Ø´Ø®Øµ Ù…Ù† Ø§Ù„Ù…ÙˆØª.
            </div>

            <div class="rule-item">
                <span class="rule-title" style="color: var(--accent-gold);">ğŸ•µï¸â€â™‚ï¸ Ø§Ù„Ù…Ø­Ù‚Ù‚</span>
                ÙŠÙƒØ´Ù Ù‡ÙˆÙŠØ© Ù„Ø§Ø¹Ø¨ ÙˆØ§Ø­Ø¯ ÙÙŠ Ø§Ù„Ù„ÙŠÙ„ (Ù…Ø¬Ø±Ù… Ø£Ùˆ Ø¨Ø±ÙŠØ¡).
            </div>

            <div class="rule-item">
                <span class="rule-title" style="color: var(--jester-purple);">ğŸƒ Ø§Ù„Ù…Ù‡Ø±Ø¬</span>
                Ù‡Ø¯ÙÙ‡ Ø£Ù† ÙŠØªÙ… Ø¥Ø¹Ø¯Ø§Ù…Ù‡ ÙÙŠ Ø§Ù„ØªØµÙˆÙŠØª Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ Ø­ØªÙ‰ ÙŠÙÙˆØ² ÙˆØ­Ø¯Ù‡.
            </div>

            <div class="rule-item">
                <span class="rule-title" style="color: var(--accent-night);">ğŸ‘¥ Ø§Ù„Ù…ÙˆØ§Ø·Ù†</span>
                Ø³Ù„Ø§Ø­Ù‡ Ø§Ù„ØªØ´ÙƒÙŠÙƒ ÙˆØ§Ù„ØªØµÙˆÙŠØª Ø§Ù„Ø°ÙƒÙŠ ÙÙŠ Ø§Ù„Ù†Ù‡Ø§Ø±.
            </div>

            <div class="rule-item">
                <span class="rule-title" style="color: var(--sniper-blue);">ğŸ¯ Ø§Ù„Ù‚Ù†Ù‘Ø§Øµ</span>
                ÙŠØ³ØªÙŠÙ‚Ø¸ ÙÙŠ Ø§Ù„Ù„ÙŠÙ„ ÙˆÙ„Ø¯ÙŠÙ‡ Ø·Ù„Ù‚Ø© (Ø£Ùˆ Ø·Ù„Ù‚ØªØ§Ù† Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø§ÙÙŠØ§Ù† Ø£Ùˆ Ø£ÙƒØ«Ø± ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©).<br>
                Ø¥Ø°Ø§ Ù‚ØªÙ„ Ù…Ø§ÙÙŠØ§ âœ ÙŠÙ…ÙˆØª Ø§Ù„Ù…Ø§ÙÙŠØ§ ÙÙ‚Ø·.<br>
                Ø¥Ø°Ø§ Ù‚ØªÙ„ Ù„Ø§Ø¹Ø¨Ø§Ù‹ Ø¨Ø±ÙŠØ¦Ø§Ù‹ âœ ÙŠÙ…ÙˆØª Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø¨Ø±ÙŠØ¡ ÙˆØ§Ù„Ù‚Ù†Ù‘Ø§Øµ Ù…Ø¹Ø§Ù‹!
            </div>

            <div class="rule-item">
                <span class="rule-title" style="color: var(--accent-night);">ğŸ² Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©</span>
                Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ø®ÙŠØ§Ø± Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© ÙÙŠ Ø´Ø§Ø´Ø© ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±:
                <br>ØªØ¸Ù‡Ø± ÙƒÙ„ ÙŠÙˆÙ… Ø­Ø§Ù„Ø© Ø®Ø§ØµØ© ØªØºÙŠÙ‘Ø± Ø¬Ùˆ Ø§Ù„Ù„Ø¹Ø¨Ø©ØŒ Ù…Ø«Ù„:
                <br>â€¢ ğŸŒ«ï¸ <b>Ø§Ù„Ø¶Ø¨Ø§Ø¨ Ø§Ù„ÙƒØ«ÙŠÙ</b>: ÙŠØ®ÙÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆØ§Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµÙˆÙŠØª.
                <br>â€¢ âš¡ <b>Ù…Ø­Ø§ÙƒÙ…Ø© Ù…Ø³ØªØ¹Ø¬Ù„Ø©</b>: ÙŠÙ‚Ù„Ù‘ ÙˆÙ‚Øª Ø§Ù„ØªØµÙˆÙŠØª.
                <br>â€¢ ğŸ¤« <b>Ø£Ù…Ø± Ø¨Ø§Ù„ØµÙ…Øª</b>: Ø§Ù„ÙŠÙˆÙ… ÙŠÙÙØ¶Ù‘Ù„ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„ØªÙˆØ§ØµÙ„ Ø¨Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª ÙÙ‚Ø·.
                <br>â€¢ â˜€ï¸ <b>Ø³Ù…Ø§Ø¡ ØµØ§ÙÙŠØ©</b>: ÙŠÙˆÙ… Ø¹Ø§Ø¯ÙŠ.
            </div>
        </div>

        <button class="modal-btn" onclick="closeRules()" style="margin-top: 20px;">ÙÙ‡Ù…Øª</button>
    </div>
</div>

<div id="log-modal-overlay">
    <div class="custom-modal" style="border-color: #fff;">
        <h2 style="color: #fff; margin-bottom: 20px;">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h2>
        <div class="log-content" id="game-log-list">
            <div style="text-align:center; color:#777;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø« Ø¨Ø¹Ø¯...</div>
        </div>
        <button class="modal-btn" onclick="closeLogs()" style="margin-top: 20px;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div id="custom-modal-overlay">
    <div class="custom-modal" id="modal-box">
        <span class="modal-icon" id="modal-icon">âš ï¸</span>
        <div class="modal-title" id="modal-title">ØªÙ†Ø¨ÙŠÙ‡</div>
        <div class="modal-message" id="modal-msg">Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù‡Ù†Ø§</div>
        <button class="modal-btn" onclick="closeModal()">Ø­Ø³Ù†Ø§Ù‹</button>
    </div>
</div>

<div id="room-transition-overlay">
    <div class="room-panel">
        <div class="room-panel-icon">ğŸšª</div>
        <div class="room-panel-title" id="room-transition-title">Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©...</div>
        <div class="room-panel-sub">ÙŠØªÙ… ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØºØ±ÙØ©ØŒ Ù„Ø§ ØªÙ†Ø¸Ø± Ù„Ù„Ø£Ø³Ù…Ø§Ø¡ ğŸ‘€</div>
    </div>
</div>

<div id="canvas-container">
    <!-- ÙƒØ±Øª Ø§Ù„Ù…Ø§ÙÙŠØ§ -->
    <div class="char-card-bg char-mafia" style="--r:-11deg;">
        <div class="char-card-inner">
            <div class="char-icon">ğŸ˜ˆ</div>
            <div class="char-label">Ø§Ù„Ù…Ø§ÙÙŠØ§</div>
            <div class="char-sub">Ø²Ø¹ÙŠÙ… Ø§Ù„Ø¹ØµØ§Ø¨Ø© ÙÙŠ Ø§Ù„Ø¸Ù„Ø§Ù„</div>
        </div>
    </div>

    <!-- ÙƒØ±Øª Ø§Ù„Ø·Ø¨ÙŠØ¨ -->
    <div class="char-card-bg char-doc" style="--r:7deg;">
        <div class="char-card-inner">
            <div class="char-icon">ğŸ©º</div>
            <div class="char-label">Ø§Ù„Ø·Ø¨ÙŠØ¨</div>
            <div class="char-sub">Ø¨ÙŠÙ† Ø§Ù„Ø­ÙŠØ§Ø© ÙˆØ§Ù„Ù…ÙˆØª</div>
        </div>
    </div>

    <!-- ÙƒØ±Øª Ø§Ù„Ù…Ø­Ù‚Ù‚ -->
    <div class="char-card-bg char-det" style="--r:6deg;">
        <div class="char-card-inner">
            <div class="char-icon">ğŸ•µï¸â€â™‚ï¸</div>
            <div class="char-label">Ø§Ù„Ù…Ø­Ù‚Ù‚</div>
            <div class="char-sub">ÙŠØ¯ÙˆØ± Ø®Ù„Ù Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø©</div>
        </div>
    </div>

    <!-- ÙƒØ±Øª Ø§Ù„Ø¹Ù…Ø¯Ø© -->
    <div class="char-card-bg char-mayor" style="--r:-5deg;">
        <div class="char-card-inner">
            <div class="char-icon">ğŸ©</div>
            <div class="char-label">Ø§Ù„Ø¹Ù…Ø¯Ø©</div>
            <div class="char-sub">ØµÙˆØªØ§Ù† ÙÙŠ Ø³Ø§Ø­Ø© Ø§Ù„ØªØµÙˆÙŠØª</div>
        </div>
    </div>

    <!-- ÙƒØ±Øª Ø§Ù„Ù…Ù‡Ø±Ø¬ -->
    <div class="char-card-bg char-jester" style="--r:3deg;">
        <div class="char-card-inner">
            <div class="char-icon">ğŸƒ</div>
            <div class="char-label">Ø§Ù„Ù…Ù‡Ø±Ø¬</div>
            <div class="char-sub">ÙŠÙÙˆØ² Ø¥Ø°Ø§ Ø­ÙƒÙ…ØªÙ… Ø¹Ù„ÙŠÙ‡</div>
        </div>
    </div>

    <!-- ÙƒØ±Øª Ø§Ù„Ù‚Ù†Ù‘Ø§Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
    <div class="char-card-bg char-sniper" style="--r:4deg;">
        <div class="char-card-inner">
            <div class="char-icon">ğŸ¯</div>
            <div class="char-label">Ø§Ù„Ù‚Ù†Ù‘Ø§Øµ</div>
            <div class="char-sub">Ø·Ù„Ù‚Ø© Ù‚Ø¯ ØªØºÙŠÙ‘Ø± Ù…Ø¬Ø±Ù‰ Ø§Ù„Ù„Ø¹Ø¨Ø©</div>
        </div>
    </div>

    <!-- ÙƒØ±Øª Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ† -->
    <div class="char-card-bg char-citizen">
        <div class="char-card-inner">
            <div class="char-icon">ğŸ‘¥</div>
            <div class="char-label">Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙˆÙ†</div>
            <div class="char-sub">Ø§Ù„Ù‚ÙˆØ© ÙÙŠ Ø§Ù„Ø´Ùƒ ÙˆØ§Ù„ØªØµÙˆÙŠØª</div>
        </div>
    </div>
</div>


<div class="container">
 <div class="made-by-tag">Made By Feras</div>
    <h1>MAFIA 3D</h1>

    <div id="setup-screen">
        <h3>1. ØºØ±ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
        <input type="text" id="new-player-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„..." onkeypress="handleEnter(event)">
        <div style="display:flex; gap:5px;">
            <button onclick="addPlayer()" class="btn-outline">â• Ø¶Ù… Ù„Ù„ÙØ±ÙŠÙ‚</button>
            <button onclick="clearSavedNames()" class="btn-outline"
                    style="width:30%; border-color:var(--mafia-red); color:var(--mafia-red);">ğŸ—‘ï¸ Ù…Ø³Ø­
            </button>
        </div>
        <div id="names-list" style="margin: 20px 0; min-height: 50px;"></div>
        <button id="to-roles-btn" onclick="goToRoleConfig()" disabled>Ø§Ù„ØªØ§Ù„ÙŠ: Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ© â¡ï¸</button>
    </div>

    <div id="role-config-screen" class="hidden">
        <h3>2. ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù…</h3>
        <p>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù†Ø´Ø·ÙˆÙ†:
            <span id="total-players-count"
                  style="color:var(--accent-night); font-weight:bold;">0</span></p>

        <div class="card-box">
            <div class="role-input-row">
                <label style="color:var(--mafia-red); font-weight:bold;">ğŸ˜ˆ Ù…Ø§ÙÙŠØ§</label>
                <input type="number" id="num-mafia" value="1" min="1"
                       onchange="calcCitizens()"
                       style="width:60px; padding:5px; margin:0;">
            </div>
            <div class="role-input-row">
                <label style="color:var(--mayor-orange); font-weight:bold;">ğŸ© Ø¹Ù…Ø¯Ø©</label>
                <input type="number" id="num-mayor" value="0" min="0"
                       onchange="calcCitizens()"
                       style="width:60px; padding:5px; margin:0;">
            </div>
            <div class="role-input-row">
                <label style="color:var(--success-green); font-weight:bold;">ğŸ©º Ø·Ø¨ÙŠØ¨</label>
                <input type="number" id="num-doc" value="1" min="0"
                       onchange="calcCitizens()"
                       style="width:60px; padding:5px; margin:0%;">
            </div>
            <div class="role-input-row">
                <label style="color:var(--accent-gold); font-weight:bold;">ğŸ•µï¸â€â™‚ï¸ Ù…Ø­Ù‚Ù‚</label>
                <input type="number" id="num-det" value="1" min="0"
                       onchange="calcCitizens()"
                       style="width:60px; padding:5px; margin:0;">
            </div>
            <div class="role-input-row">
                <label style="color:var(--sniper-blue); font-weight:bold;">ğŸ¯ Ù‚Ù†Ù‘Ø§Øµ</label>
                <input type="number" id="num-sniper" value="0" min="0"
                       onchange="calcCitizens()"
                       style="width:60px; padding:5px; margin:0%;">
            </div>
            <div class="role-input-row">
                <label style="color:var(--jester-purple); font-weight:bold;">ğŸƒ Ù…Ù‡Ø±Ø¬</label>
                <input type="number" id="num-jester" value="0" min="0"
                       onchange="calcCitizens()"
                       style="width:60px; padding:5px; margin:0%;">
            </div>
            <div class="role-input-row" style="border:none;">
                <label>ğŸ‘¥ Ù…ÙˆØ§Ø·Ù†ÙˆÙ†</label>
                <span id="num-citizen" style="font-weight:bold; font-size:1.5rem;">0</span>
            </div>
        </div>

        <div class="switch-container">
            <span>ğŸŒªï¸ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©</span>
            <label class="switch">
                <input type="checkbox" id="events-toggle">
                <span class="slider"></span>
            </label>
        </div>

        <button onclick="finalizeRolesAndStart()">ğŸš€ Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù…Ù‡Ù…Ø©</button>
        <button onclick="backToNames()" class="btn-outline">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div id="avatar-select-screen" class="hidden" style="text-align: center;">
        <h3>Ø§Ø®ØªØ± Ù…Ø¸Ù‡Ø±Ùƒ ğŸ­</h3>
        <p style="color:#aaa;">Ø£Ø¹Ø· Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ù€ <b id="avatar-picker-name" style="color:#fff">--</b></p>

        <div class="avatar-selection-grid" id="avatar-options-container"></div>

        <button onclick="generateAvatarOptions()" class="refresh-btn">ğŸ”„ ØªØ¬Ø¯ÙŠØ¯</button>

        <button onclick="confirmAvatarSelection()" class="btn-green" disabled id="confirm-avatar-btn">âœ… ØªØ£ÙƒÙŠØ¯</button>
    </div>

    <div id="reveal-screen" class="hidden">
        <h3>Ù…Ù„Ù Ø³Ø±ÙŠ Ù„Ù„ØºØ§ÙŠØ© ğŸ“</h3>

        <div class="flip-card" id="role-flip-card">
            <div class="flip-card-inner">
                <div class="flip-card-front">
                    <p style="color:#888;">Ù‡ÙˆÙŠØ© Ø§Ù„Ø¹Ù…ÙŠÙ„:</p>
                    <img id="reveal-avatar" src=""
                         style="width:90px;height:90px;border-radius:50%;border:2px solid(var(--glass-border));
                         margin:15px 0;background:#1a1a1a;box-shadow:0 6px 16px rgba(0,0,0,0.8);">
                    <h2 id="reveal-title" style="font-size:2.2rem; color:var(--accent-gold);">--</h2>
                    <div style="margin-top:20px; color:#aaa; font-size:0.9rem;">Ø§Ø¶ØºØ· Ù„ÙØªØ­ Ø§Ù„Ù…Ù„Ù ğŸ‘†</div>
                </div>
                <div class="flip-card-back">
                    <p>Ù‡ÙˆÙŠØªÙƒ Ø§Ù„Ø³Ø±ÙŠØ©:</p>
                    <h1 id="role-text">--</h1>
                    <p id="role-desc"
                       style="background:rgba(255,255,255,0.1); padding:10px; border-radius:8px; font-size:0.9rem;">--</p>
                </div>
            </div>
        </div>

        <div style="margin-top:20px;">
            <button id="reveal-action-btn" onclick="handleRevealClick()" class="btn-green">ğŸ”“ ÙØªØ­ Ø§Ù„Ù…Ù„Ù</button>
        </div>
    </div>

    <div id="rotation-screen" class="hidden">
        <h2 id="phase-title">--</h2>
        <div id="event-banner"></div>

        <div id="vote-timer-bar" class="hidden">
            â³ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„ØªØµÙˆÙŠØª:
            <span id="vote-timer-text">03:00</span>
            <button type="button" id="vote-timer-pause-btn" onclick="toggleVoteTimerPause()" title="Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª">â¸ï¸</button>
            <button type="button" onclick="addVoteTime(30)" title="+30 Ø«Ø§Ù†ÙŠØ©">+30Ø«</button>
        </div>

        <div id="turn-wait-view" style="text-align:center; padding: 20px 0;">
            <p>Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¢Ù†:</p>
            <img id="turn-player-avatar" src=""
                 style="width:70px; height:70px; border-radius:50%; border:2px solid #fff; margin:10px auto;
                 display:block; background:#1a1a1a; box-shadow:0 6px 16px rgba(0,0,0,0.8);">
            <h1 id="turn-player-name"
                style="font-size: 2.5rem; margin: 10px 0; text-shadow:0 0 30px rgba(255,255,255,0.2);">--</h1>
            <p style="opacity:0.7;">Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø³Ø±ÙŠØ©ØŒ Ù„Ø§ ØªÙ†Ø¸Ø± Ù„Ù„Ø´Ø§Ø´Ø©.</p>

            <button id="hold-to-reveal-btn" class="hold-btn btn-outline" style="margin-top:20px;"
                    onmousedown="startHold(this, event)"
                    ontouchstart="startHold(this, event)"
                    onmouseup="cancelHold(this, event)"
                    ontouchend="cancelHold(this, event)"
                    onmouseleave="cancelHold(this, event)"
                    oncontextmenu="return false;">
                <div class="fill-bar"></div>
                <span class="hold-label" style="position:relative; z-index:2;">Ø§Ø¶ØºØ· Ù…Ø·ÙˆÙ„Ø§Ù‹ Ù„Ù„ÙƒØ´Ù ğŸ‘†</span>
            </button>
        </div>

        <div id="turn-action-view" class="hidden">
            <div style="display:flex; justify-content:space-between;">
                <h3 id="action-role-title">--</h3>
            </div>
            <p id="action-instruction" style="color:#aaa;">--</p>

            <div class="players-grid" id="action-grid"></div>

            <div id="binary-vote-buttons" class="hidden"
                 style="margin-top:20px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn-red" onclick="submitBinaryVote(true)">â˜ ï¸ Ø¥Ø¹Ø¯Ø§Ù…</button>
                <button class="btn-green" onclick="submitBinaryVote(false)">ğŸ›¡ï¸ Ø¹ÙÙˆ</button>
            </div>

            <div style="margin-top: 20px;">
                <button id="confirm-action-btn" onclick="confirmTurnAction()">âœ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø£Ù…Ø±</button>
            </div>
        </div>
    </div>

    <div id="defense-screen" class="hidden">
        <h2 style="color: var(--mafia-red); text-align:center;">âš–ï¸ Ø§Ù„Ù…Ø­Ø§ÙƒÙ…Ø© Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠØ©</h2>
        <div class="card-box" style="text-align:center;">
            <p>Ø§Ù„Ù…ØªÙ‡Ù…:</p>
            <div class="defense-avatar-wrap">
                <div class="defense-timer" id="defense-timer-ring">
                    <img id="defendant-avatar" src="" alt="defendant">
                </div>
            </div>
            <h1 id="defendant-name" style="font-size:2.4rem; margin:10px 0 4px;">--</h1>

            <div class="defense-timer-label">
                Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ø¯ÙØ§Ø¹: <span id="defense-timer-text">20</span> Ø«Ø§Ù†ÙŠØ©
            </div>
            <hr style="margin:20px 0; border-color:rgba(255,255,255,0.1);">
            <p>Ø§Ø³ØªØºÙ„ ÙˆÙ‚ØªÙƒâ€¦ ÙƒÙ„ ÙƒÙ„Ù…Ø© Ù‚Ø¯ ØªÙ†Ù‚Ø°Ùƒ Ø£Ùˆ ØªØ¯ÙŠÙ†Ùƒ!</p>
            <br><br>
            <button onclick="startConfirmationPhase()" class="btn-red">Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚ØªØŒ Ø§Ù„Ø­ÙƒÙ…!</button>
        </div>
    </div>

    <div id="results-screen" class="hidden">
        <h2 id="results-title" style="text-align:center;">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù‡Ù…Ø©</h2>
        <div class="card-box">
            <div id="results-text">--</div>
            <br>
            <div id="custom-result-buttons"></div>
            <button id="default-next-btn" onclick="proceedToNextPhase()">Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸</button>
        </div>
    </div>

</div>

<!-- ğŸ“° Ø´Ø±ÙŠØ· Ù…ÙˆØ¬Ø² Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ù…ØªØ­Ø±Ù‘Ùƒ Ø®Ø§Ø±Ø¬ Ø¥Ø·Ø§Ø± Ø§Ù„ÙƒØ±Øª -->
<div id="news-ticker">
    <div id="news-ticker-label">
        <span class="icon">ğŸ“°</span>
        <span>Ù…ÙˆØ¬Ø² Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</span>
    </div>
    <div id="news-ticker-marquee">
        <div id="news-ticker-content">
            <span class="ticker-segment">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø¨Ø§Ø± Ø¨Ø¹Ø¯...</span>
            <span class="ticker-segment" aria-hidden="true">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø¨Ø§Ø± Ø¨Ø¹Ø¯...</span>
        </div>
    </div>
</div>

<script>
    /* ÙƒØ´Ù Ø¥Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    function detectMobileLayout() {
        if (window.innerWidth <= 768) {
            document.body.classList.add('is-mobile');
        } else {
            document.body.classList.remove('is-mobile');
        }
    }
    window.addEventListener('load', detectMobileLayout);
    window.addEventListener('resize', detectMobileLayout);

    function showModal(title, msg, type = 'info') {
        const overlay = document.getElementById('custom-modal-overlay');
        const box = document.getElementById('modal-box');
        const titleEl = document.getElementById('modal-title');
        const msgEl = document.getElementById('modal-msg');
        const iconEl = document.getElementById('modal-icon');

        titleEl.innerText = title;
        msgEl.innerHTML = msg;

        box.className = 'custom-modal';

        if(type === 'error') {
            box.classList.add('modal-type-error');
            iconEl.innerText = 'âŒ';
        } else if (type === 'success') {
            box.classList.add('modal-type-success');
            iconEl.innerText = 'âœ…';
        } else {
            iconEl.innerText = 'â„¹ï¸';
        }

        overlay.classList.add('active');
        renderAllEmojis(overlay);
    }

    function closeModal() {
        document.getElementById('custom-modal-overlay').classList.remove('active');
    }

    function openRules() { document.getElementById('rules-modal-overlay').classList.add('active'); }
    function closeRules() { document.getElementById('rules-modal-overlay').classList.remove('active'); }

    function openLogs() {
        renderLogs();
        document.getElementById('log-modal-overlay').classList.add('active');
    }
    function closeLogs() { document.getElementById('log-modal-overlay').classList.remove('active'); }

    function roomTransition(targetScreenId, titleText, afterFn) {
        const overlay = document.getElementById('room-transition-overlay');
        const titleEl = document.getElementById('room-transition-title');

        if (titleText) titleEl.textContent = titleText;

        overlay.classList.add('active');

        setTimeout(() => {
            if (typeof afterFn === 'function') {
                afterFn();
            } else if (targetScreenId) {
                showScreen(targetScreenId);
            }
            setTimeout(() => {
                overlay.classList.remove('active');
            }, 350);
        }, 450);
    }

    function updateEnvironment(isNight) {
        const body = document.body;
        if (isNight) {
            body.classList.add('is-night');
            body.classList.remove('is-day');
        } else {
            body.classList.add('is-day');
            body.classList.remove('is-night');
        }
    }

    function setupParallax() {
        // ØªÙ… ØªØ¹Ø·ÙŠÙ„ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¨Ø§Ù„Ù…Ø§ÙˆØ³
    }

    let players = [];
    let dayCount = 0;
    let phase = 'setup';
    let turnIndex = 0;
    let nightActions = { mafiaTarget: null, doctorTarget: null, sniperShots: [] };
    let dayVotes = {};
    let confirmationVotes = { yes: 0, no: 0 };
    let defendantId = null;
    let activePlayer = null;
    let selectedPlayerId = null;
    let gameLogs = [];
    let currentTempAvatar = null;
    let defenseTimerInterval = null;
    let voteTimerInterval = null;
    let voteTimerRemaining = 0;
    let voteTimerPaused = false;
    let savedAvatars = {};
    let sniperBullets = {};

    let holdTimer = null;
    const HOLD_DURATION = 1500;
    let eventsEnabled = false;
    let currentEvent = null;

    // === Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¤Ø«Ø±Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ© (Web Audio API) ===
    let audioCtx = null;

    function initSfx() {
        // ÙŠØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø³ÙŠØ§Ù‚ Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªÙØ§Ø¹Ù„ Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„Ù‡ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø©
        if (!audioCtx) {
             try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) {
                    audioCtx = new AudioContext();
                }
            } catch (e) {
                console.error('Web Audio API not supported');
            }
        }
        if (audioCtx && audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }

    function playSfx(type) {
        if (!audioCtx) initSfx();
        if (!audioCtx) return;
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¹Ù„Ù‚Ø§Ù‹
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }

        const now = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();

        osc.connect(gain);
        gain.connect(audioCtx.destination);

        if (type === 'click') {
            // Ù†Ù‚Ø±Ø© Ø¨Ø³ÙŠØ·Ø©
            osc.type = 'sine';
            osc.frequency.setValueAtTime(800, now);
            osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
        } 
        else if (type === 'notify') {
            // ØªÙ†Ø¨ÙŠÙ‡ Ù†Ø§Ø¹Ù… (Ø¬Ø±Ø³)
            osc.type = 'sine';
            osc.frequency.setValueAtTime(523.25, now); // C5
            osc.frequency.setValueAtTime(659.25, now + 0.1); // E5
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0.1, now + 0.2);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
            osc.start(now);
            osc.stop(now + 0.5);
        } 
        else if (type === 'kill') {
             // ØµÙˆØª Ù…Ù†Ø®ÙØ¶ ÙˆÙ…Ø²Ø¹Ø¬ (Ù…ÙˆØª)
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.exponentialRampToValueAtTime(50, now + 0.3);
            gain.gain.setValueAtTime(0.2, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            osc.start(now);
            osc.stop(now + 0.3);
        }
        else if (type === 'night') {
            // ØµÙˆØª ØºØ§Ù…Ø¶ Ù„Ù„ÙŠÙ„
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(300, now);
            osc.frequency.linearRampToValueAtTime(100, now + 1.5);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 1.5);
            osc.start(now);
            osc.stop(now + 1.5);
        } 
        else if (type === 'day') {
            // ØµÙˆØª Ù…Ø´Ø±Ù‚ Ù„Ù„Ù†Ù‡Ø§Ø± (ÙƒÙˆØ±Ø¯ Ø³Ø±ÙŠØ¹)
            // Ø¨Ù…Ø§ Ø£Ù†Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… osc ÙˆØ§Ø­Ø¯ Ù‡Ù†Ø§ Ù„Ù„ØªØ¨Ø³ÙŠØ·ØŒ Ø³Ù†Ø¹Ù…Ù„ ØµÙˆØª ØµØ§Ø¹Ø¯
            osc.type = 'sine';
            osc.frequency.setValueAtTime(400, now);
            osc.frequency.exponentialRampToValueAtTime(800, now + 0.5);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 1.0);
            osc.start(now);
            osc.stop(now + 1.0);
        }
    }

    const randomEventsList = [
        { id: 'fog', title: 'ğŸŒ«ï¸ Ø§Ù„Ø¶Ø¨Ø§Ø¨ Ø§Ù„ÙƒØ«ÙŠÙ', desc: 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø±Ø¤ÙŠØ© Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„ÙŠÙˆÙ…!' },
        { id: 'rush', title: 'âš¡ Ù…Ø­Ø§ÙƒÙ…Ø© Ù…Ø³ØªØ¹Ø¬Ù„Ø©', desc: 'ÙˆÙ‚Øª Ø§Ù„ØªØµÙˆÙŠØª Ù†ØµÙ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø¹ØªØ§Ø¯Ø©.' },
        { id: 'silence', title: 'ğŸ¤« Ø£Ù…Ø± Ø¨Ø§Ù„ØµÙ…Øª', desc: 'Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„ÙƒÙ„Ø§Ù… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµÙˆÙŠØª (Ø§ØªÙÙ‚ÙˆØ§ Ø¨ÙŠÙ†ÙƒÙ…).' },
        { id: 'clear', title: 'â˜€ï¸ Ø³Ù…Ø§Ø¡ ØµØ§ÙÙŠØ©', desc: 'ÙŠÙˆÙ… Ù‡Ø§Ø¯Ø¦ Ø¨Ø¯ÙˆÙ† Ø£Ø­Ø¯Ø§Ø« ØºØ±ÙŠØ¨Ø©.' }
    ];

    function renderAllEmojis(scope) {
        if (typeof twemoji === 'undefined') return;
        twemoji.parse(scope || document.body, {
            folder: 'svg',
            ext: '.svg',
            base: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/',
            className: 'emoji-svg'
        });
    }
    window.onload = () => {
        try {
            savedAvatars = JSON.parse(localStorage.getItem('mafiaAvatars') || '{}');
        } catch(e) { savedAvatars = {}; }

        const savedNames = JSON.parse(localStorage.getItem('mafiaNames') || '[]');
        savedNames.forEach(name => {
            players.push({ id: players.length, name: name, role: 'Ù…ÙˆØ§Ø·Ù†', isAlive: true, avatar: null });
        });

        renderNamesList();
        updateEnvironment(true);
        setupParallax();
        renderAllEmojis();
        renderNewsSummary();

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø¤Ø«Ø±Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ©
        initSfx();

        // Ø£ÙŠ Ø²Ø± ÙŠÙ†Ø¶ØºØ· â†’ ØµÙˆØª ÙƒÙ„ÙŠÙƒ Ø¨Ø³ÙŠØ·
        document.addEventListener('click', (ev) => {
            const btn = ev.target.closest('button');
            if (btn) {
                playSfx('click');
            }
        });
    };

    function showScreen(screenId) {
        const screens = [
            'setup-screen',
            'role-config-screen',
            'avatar-select-screen',
            'reveal-screen',
            'rotation-screen',
            'defense-screen',
            'results-screen'
        ];
        screens.forEach(id => {
            const el = document.getElementById(id);
            el.classList.add('hidden');
            el.style.display = 'none';
        });
        const target = document.getElementById(screenId);
        target.classList.remove('hidden');
        target.style.display = 'block';
    }

    function handleEnter(e) { if(e.key === 'Enter') addPlayer(); }

    function addPlayer() {
        const input = document.getElementById('new-player-name');
        const name = input.value.trim();
        if (!name) return;
        if (players.some(p => p.name === name)) {
            showModal("Ø®Ø·Ø£", "Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹!", "error");
            return;
        }
        players.push({ id: players.length, name: name, role: 'Ù…ÙˆØ§Ø·Ù†', isAlive: true, avatar: null });
        const currentNames = players.map(p => p.name);
        localStorage.setItem('mafiaNames', JSON.stringify(currentNames));
        input.value = '';
        renderNamesList();
    }

    function clearSavedNames() {
        localStorage.removeItem('mafiaNames');
        localStorage.removeItem('mafiaAvatars');
        savedAvatars = {};
        players = [];
        renderNamesList();
        renderNewsSummary();
        showModal("ØªÙ…", "ØªÙ… Ù…Ø³Ø­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ø£ÙØ§ØªØ§Ø±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©.", "success");
    }

    function renderNamesList() {
        const list = document.getElementById('names-list');
        const btn = document.getElementById('to-roles-btn');
        list.innerHTML = players.map(p => `
            <span class="name-tag">
                ${p.name}
            </span>`).join('');
        document.getElementById('total-players-count').innerText = players.length;
        btn.disabled = (players.length < 3);
    }

      function addLog(text) {
        const time = new Date().toLocaleTimeString('ar-EG', {
            hour: '2-digit',
            minute: '2-digit'
        });

        const last = gameLogs[gameLogs.length - 1];
        if (last && last.text === text) {
            return;
        }

        gameLogs.push({ text, time });
        renderNewsSummary();

        // ØµÙˆØª Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø³ÙŠØ· Ù„Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ù‡Ù…Ø©
        const firstChar = text && text[0];
        if (firstChar === 'ğŸ’€' || firstChar === 'ğŸ¯' || firstChar === 'âœ¨' || firstChar === 'âš–ï¸' || firstChar === 'ğŸƒ') {
            playSfx('notify');
        }
    }


    /* âœ… Ù…ÙˆØ¬Ø² Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ù…ØªØ­Ø±Ùƒ Ø¨Ø¯ÙˆÙ† ØªÙ‚Ø·ÙŠØ¹ Ø£Ùˆ Ø±Ø¬ÙˆØ¹ Ù…Ù† Ø§Ù„Ù†Øµ */
    function renderNewsSummary() {
        const wrapper = document.getElementById('news-ticker-marquee');
        const el = document.getElementById('news-ticker-content');
        if (!wrapper || !el) return;

        let rawTextItems = '';

        if (gameLogs.length === 0) {
            rawTextItems = '<span class="ticker-item" style="color:#aaa">â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«...</span>';
        } else {
            // Ø¢Ø®Ø± 20 Ø­Ø¯Ø« + Ø¥Ø²Ø§Ù„Ø© ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„Ù†Øµ ÙˆØ±Ø§Ø¡ Ø¨Ø¹Ø¶
            const uniqueLogs = [];
            let lastTxt = '';
            const logsReversed = gameLogs.slice(-20).reverse();

            for (let log of logsReversed) {
                if (log.text !== lastTxt) {
                    uniqueLogs.push(log);
                    lastTxt = log.text;
                }
            }

            rawTextItems = uniqueLogs.map(log =>
                `<span class="ticker-item">
                    <span style="color:var(--accent-gold); font-weight:bold; margin-left:5px;">[${log.time}]</span>${log.text}
                 </span>
                 <span class="ticker-item" style="opacity:0.5; margin:0 15px;">â™¦</span>`
            ).join('');
        }

        // Ù†Ø­Ø· Ù†Ø³Ø®ØªÙŠÙ† Ù†ÙØ³ Ø¨Ø¹Ø¶ Ø¹Ø´Ø§Ù† ÙŠØµÙŠØ± Ø³ÙƒØ±ÙˆÙˆÙ„ Ø­Ù„Ù‚ÙŠ Ø¨Ø¯ÙˆÙ† Ù‚ÙØ²Ø§Øª
        el.innerHTML = `
            <div class="ticker-segment">${rawTextItems}</div>
            <div class="ticker-segment">${rawTextItems}</div>
        `;

        const segment = el.querySelector('.ticker-segment');
        if (!segment) return;

        // Ø¹Ø±Ø¶ Ù†Ø³Ø®Ø© ÙˆØ§Ø­Ø¯Ø© Ù…Ù† Ø§Ù„Ù†Øµ
        const segmentWidth = segment.scrollWidth;
        const speed = 50; // Ø¨ÙƒØ³Ù„ ÙÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠØ©
        // Ù…Ø¯Ø© Ø§Ù„Ø­Ø±ÙƒØ© = Ø§Ù„Ù…Ø³Ø§ÙØ© / Ø§Ù„Ø³Ø±Ø¹Ø© (ÙˆÙ†Ø­Ø· Ø­Ø¯ Ø£Ø¯Ù†Ù‰)
        const duration = Math.max(15, segmentWidth / speed);

        // Ù†Ø¹ÙŠØ¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ù…Ø¹ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        el.style.animation = 'none';
        void el.offsetWidth; // trick Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨
        el.style.animation = `moveLeft ${duration}s linear infinite`;

        // Ù†Ø­ÙˆÙ„ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ù„Ù€ SVG
        renderAllEmojis(el);
    }

    function goToRoleConfig() {
        calcCitizens();
        roomTransition('role-config-screen', 'ğŸ­ ØºØ±ÙØ© ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±');
    }

    function calcCitizens() {
        const total = players.length;
        const mafia = parseInt(document.getElementById('num-mafia').value) || 0;
        const doc = parseInt(document.getElementById('num-doc').value) || 0;
        const det = parseInt(document.getElementById('num-det').value) || 0;
        const sniper = parseInt(document.getElementById('num-sniper').value) || 0;
        const jester = parseInt(document.getElementById('num-jester').value) || 0;
        const mayor = parseInt(document.getElementById('num-mayor').value) || 0;

        const citizens = total - (mafia + doc + det + sniper + jester + mayor);
        const el = document.getElementById('num-citizen');
        el.innerText = citizens;
        if (citizens < 0) {
            el.style.color = '#ff4757';
            return false;
        } else {
            el.style.color = '#2ecc71';
            return true;
        }
    }

    function finalizeRolesAndStart() {
        if (!calcCitizens()) {
            showModal("ØªÙ†Ø¨ÙŠÙ‡", "Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø£ÙƒØ¨Ø± Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†!", "error");
            return;
        }
        const mafiaCount = parseInt(document.getElementById('num-mafia').value);
        const docCount = parseInt(document.getElementById('num-doc').value);
        const detCount = parseInt(document.getElementById('num-det').value);
        const sniperCount = parseInt(document.getElementById('num-sniper').value);
        const jesterCount = parseInt(document.getElementById('num-jester').value);
        const mayorCount = parseInt(document.getElementById('num-mayor').value);
        const citCount = parseInt(document.getElementById('num-citizen').innerText);

        let roles = [];
        for(let i=0; i<mafiaCount; i++) roles.push('Ù…Ø§ÙÙŠØ§');
        for(let i=0; i<docCount; i++) roles.push('Ø·Ø¨ÙŠØ¨');
        for(let i=0; i<detCount; i++) roles.push('Ù…Ø­Ù‚Ù‚');
        for(let i=0; i<sniperCount; i++) roles.push('Ù‚Ù†Ù‘Ø§Øµ');
        for(let i=0; i<jesterCount; i++) roles.push('Ù…Ù‡Ø±Ø¬');
        for(let i=0; i<mayorCount; i++) roles.push('Ø¹Ù…Ø¯Ø©');
        for(let i=0; i<citCount; i++) roles.push('Ù…ÙˆØ§Ø·Ù†');

        roles.sort(() => Math.random() - 0.5);
        players.forEach((p, i) => p.role = roles[i]);

        const mafiaTotal = players.filter(p => p.role === 'Ù…Ø§ÙÙŠØ§').length;
        sniperBullets = {};
        players.forEach(p => {
            if (p.role === 'Ù‚Ù†Ù‘Ø§Øµ') {
                sniperBullets[p.id] = (mafiaTotal >= 2 ? 2 : 1);
            }
        });

        gameLogs = [];
        addLog("ğŸš€ Ø¨Ø¯Ø£Øª Ø§Ù„Ù„Ø¹Ø¨Ø©! Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†: " + players.length);
        if (Object.keys(sniperBullets).length > 0) {
    addLog("ğŸ¯ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø£Ø¯ÙˆØ§Ø± Ø®Ø§ØµØ© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¬ÙˆÙ„Ø©.");
        }

        turnIndex = 0;
        roomTransition(null, 'ğŸ­ ØºØ±ÙØ© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¸Ø§Ù‡Ø±', () => {
            prepareAvatarSelection();
        });
    }

    function prepareAvatarSelection() {
        if (turnIndex >= players.length) {
            startNight();
            return;
        }
        const p = players[turnIndex];
        showScreen('avatar-select-screen');
        document.getElementById('avatar-picker-name').innerText = p.name;
        document.getElementById('confirm-avatar-btn').disabled = true;
        currentTempAvatar = null;
        generateAvatarOptions();
    }

    function generateAvatarOptions() {
        const container = document.getElementById('avatar-options-container');
        const currentPlayer = players[turnIndex];
        const savedForPlayer = currentPlayer ? savedAvatars[currentPlayer.name] : null;

        const options = [];

        if (savedForPlayer) {
            options.push({ url: savedForPlayer, isSaved: true });
        }

        const seeds = [
            Math.random().toString(36).substring(7),
            Math.random().toString(36).substring(7),
            Math.random().toString(36).substring(7)
        ];
        const bgColors = ['b6e3f4','c0aede','d1d4f9','ffd5dc','fec89a'];
        const style = 'adventurer';

        seeds.forEach((seed, i) => {
            const bg = bgColors[i % bgColors.length];
            const url = `https://api.dicebear.com/9.x/${style}/svg?seed=${seed}&backgroundColor=${bg}&backgroundType=gradientLinear&radius=50&size=96`;
            options.push({ url, isSaved: false });
        });

        container.innerHTML = options.map(opt => {
            const extraClass = opt.isSaved ? ' saved-avatar-option' : '';
            const title = opt.isSaved ? 'Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø°ÙŠ Ø§Ø®ØªØ±ØªÙ‡ ÙÙŠ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©' : 'Ø´ÙƒÙ„ Ø¬Ø¯ÙŠØ¯';
            return `<img src="${opt.url}" class="avatar-option${extraClass}" title="${title}" onclick="selectAvatarOption(this, '${opt.url}')">`;
        }).join('');

        document.getElementById('confirm-avatar-btn').disabled = true;
        currentTempAvatar = null;

        if (savedForPlayer) {
            const firstSaved = container.querySelector('.saved-avatar-option');
            if (firstSaved) {
                selectAvatarOption(firstSaved, savedForPlayer);
            }
        }
    }

    function selectAvatarOption(el, url) {
        document.querySelectorAll('.avatar-option').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
        currentTempAvatar = url;
        document.getElementById('confirm-avatar-btn').disabled = false;
    }

    function confirmAvatarSelection() {
        if (!currentTempAvatar) return;
        const p = players[turnIndex];
        p.avatar = currentTempAvatar;

        savedAvatars[p.name] = currentTempAvatar;
        try {
            localStorage.setItem('mafiaAvatars', JSON.stringify(savedAvatars));
        } catch(e) {}

        updateRevealScreen();
    }

    function updateRevealScreen() {
        showScreen('reveal-screen');
        const p = players[turnIndex];

        const card = document.getElementById('role-flip-card');
        card.classList.remove('flipped');

        document.getElementById('reveal-title').innerText = p.name;
        document.getElementById('reveal-avatar').src = p.avatar;

        const btn = document.getElementById('reveal-action-btn');
        btn.innerText = `ğŸ‘ï¸ Ø£Ù†Ø§ ${p.name}ØŒ Ø§ÙƒØ´Ù Ø§Ù„Ù…Ù„Ù`;
        btn.className = "btn-green";
        btn.onclick = showRole;
    }

    function showRole() {
        const p = players[turnIndex];
        const card = document.getElementById('role-flip-card');

        const roleText = document.getElementById('role-text');
        const roleDesc = document.getElementById('role-desc');
        roleText.innerText = p.role;
        roleText.style.color = getRoleColor(p.role);

        let desc = "";
        if (p.role === 'Ù…Ø§ÙÙŠØ§') desc = "Ø§Ù„Ù‡Ø¯Ù: Ø§Ù„Ù‚Ø¶Ø§Ø¡ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ†.";
        else if (p.role === 'Ø·Ø¨ÙŠØ¨') desc = "Ø§Ù„Ù‡Ø¯Ù: Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø£Ø¨Ø±ÙŠØ§Ø¡ Ù…Ù† Ø§Ù„Ù…ÙˆØª.";
        else if (p.role === 'Ù…Ø­Ù‚Ù‚') desc = "Ø§Ù„Ù‡Ø¯Ù: ÙƒØ´Ù Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø¬Ø±Ù…ÙŠÙ†.";
        else if (p.role === 'Ù‚Ù†Ù‘Ø§Øµ') desc = "ØªØ³ØªÙŠÙ‚Ø¸ ÙÙŠ Ø§Ù„Ù„ÙŠÙ„ ÙˆÙ„Ø¯ÙŠÙƒ Ø·Ù„Ù‚Ø© (Ø£Ùˆ Ø·Ù„Ù‚ØªØ§Ù† Ø¥Ù† ÙˆÙØ¬Ø¯ Ù…Ø§ÙÙŠØ§Ù† Ø£Ùˆ Ø£ÙƒØ«Ø±). ÙŠÙ…ÙƒÙ†Ùƒ Ø£Ù† ØªØ®ØªØ§Ø± Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù†Ø§Ø± Ø£Ùˆ Ø¹Ø¯Ù… Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚. Ø¥Ø°Ø§ Ù‚ØªÙ„Øª Ù…Ø§ÙÙŠØ§ ÙØ°Ù„Ùƒ Ù„ØµØ§Ù„Ø­ Ø§Ù„ÙØ±ÙŠÙ‚ØŒ Ø£Ù…Ø§ Ø¥Ø°Ø§ Ù‚ØªÙ„Øª Ø¨Ø±ÙŠØ¦Ø§Ù‹ ØªÙ…ÙˆØª Ù…Ø¹Ù‡!";
        else if (p.role === 'Ù…Ù‡Ø±Ø¬') desc = "Ø§Ù„Ù‡Ø¯Ù: Ø®Ø¯Ø¹Ù‡Ù… Ù„ÙŠØªÙ… Ø¥Ø¹Ø¯Ø§Ù…Ùƒ ÙÙŠ Ø§Ù„ØªØµÙˆÙŠØª!"; 
        else if (p.role === 'Ø¹Ù…Ø¯Ø©') desc = "Ø£Ù†Øª Ù…ÙˆØ§Ø·Ù† Ø°Ùˆ Ù†ÙÙˆØ°. ØµÙˆØªÙƒ ÙÙŠ Ø§Ù„Ù†Ù‡Ø§Ø± ÙŠØ­Ø³Ø¨ Ø¨ØµÙˆØªÙŠÙ†!";
        else desc = "Ø§Ù„Ù‡Ø¯Ù: ÙƒØ´Ù Ø§Ù„Ù…Ø§ÙÙŠØ§ Ø¨Ø§Ù„ØªØµÙˆÙŠØª.";

        roleDesc.innerText = desc;

        card.classList.add('flipped');

        const btn = document.getElementById('reveal-action-btn');
        btn.innerText = "Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸";
        btn.className = "btn-outline";
        btn.onclick = () => {
            turnIndex++;
            prepareAvatarSelection();
        };
    }

    function getRoleColor(role) {
        if (role === 'Ù…Ø§ÙÙŠØ§') return '#ff2e63';
        if (role === 'Ø·Ø¨ÙŠØ¨') return '#08d9d6';
        if (role === 'Ù…Ø­Ù‚Ù‚') return '#f1c40f';
        if (role === 'Ù‚Ù†Ù‘Ø§Øµ') return '#38bdf8';
        if (role === 'Ù…Ù‡Ø±Ø¬') return '#d980fa';
        if (role === 'Ø¹Ù…Ø¯Ø©') return '#e17055';
        return '#00d2ff';
    }

    function setRoleMood(role, contextPhase) {
        const b = document.body;
        b.classList.remove('role-mafia','role-doc','role-det','role-jester','role-mayor','role-citizen','role-day');
        if (!role && !contextPhase) return;
        if (contextPhase === 'day') {
            b.classList.add('role-day');
            return;
        }
        switch(role) {
            case 'Ù…Ø§ÙÙŠØ§': b.classList.add('role-mafia'); break;
            case 'Ø·Ø¨ÙŠØ¨': b.classList.add('role-doc'); break;
            case 'Ù…Ø­Ù‚Ù‚': b.classList.add('role-det'); break;
            case 'Ù…Ù‡Ø±Ø¬': b.classList.add('role-jester'); break;
            case 'Ø¹Ù…Ø¯Ø©': b.classList.add('role-mayor'); break;
            default: b.classList.add('role-citizen'); break;
        }
    }

    function startHold(btn, ev) {
        if (ev) {
            ev.preventDefault();
            ev.stopPropagation();
        }
        if (btn.disabled) return;

        if (holdTimer) {
            clearTimeout(holdTimer);
            holdTimer = null;
        }

        btn.classList.add('holding');

        holdTimer = setTimeout(() => {
            startTurn();
            cancelHold(btn);
        }, HOLD_DURATION);
    }

    function cancelHold(btn, ev) {
        if (ev) {
            ev.preventDefault();
            ev.stopPropagation();
        }
        if (holdTimer) {
            clearTimeout(holdTimer);
            holdTimer = null;
        }
        btn.classList.remove('holding');
    }

    function handleDayStartEvent() {
        const banner = document.getElementById('event-banner');
        banner.style.display = 'none';
        currentEvent = null;

        const toggle = document.getElementById('events-toggle');
        if (!toggle || !toggle.checked) return;

        const randIndex = Math.floor(Math.random() * randomEventsList.length);
        currentEvent = randomEventsList[randIndex];

        if (currentEvent.id !== 'clear') {
            banner.innerText = `${currentEvent.title}: ${currentEvent.desc}`;
            banner.style.display = 'block';
            addLog(`ğŸ² Ø­Ø¯Ø« Ø§Ù„ÙŠÙˆÙ…: ${currentEvent.title}`);
        }
    }

    function startNight() {
        phase = 'night';
        dayCount++;

        dayVotes = {};
        players.forEach(p => { if(p.isAlive) dayVotes[p.id] = 0; });

        updateEnvironment(true);
        document.getElementById('phase-title').innerText = `ğŸŒ‘ Ø§Ù„Ù„ÙŠÙ„ ${dayCount}`;
        document.getElementById('event-banner').style.display = 'none';

                playSfx('night');

        addLog(`ğŸŒ‘ Ø¨Ø¯Ø£ Ø§Ù„Ù„ÙŠÙ„ ${dayCount}`);
        nightActions = { mafiaTarget: null, doctorTarget: null, sniperShots: [] };
        turnIndex = 0;

        roomTransition(null, `ğŸŒ‘ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØºØ±ÙØ© Ø§Ù„Ù„ÙŠÙ„ ${dayCount}`, () => {
            showScreen('rotation-screen');
            document.getElementById('vote-timer-bar').classList.add('hidden');
            prepareNextTurn();
        });
    }

    function startDay() {
        phase = 'day';
        updateEnvironment(false);
        document.getElementById('phase-title').innerText = `â˜€ï¸ Ø§Ù„Ù†Ù‡Ø§Ø± ${dayCount}`;
                playSfx('day');

        addLog(`â˜€ï¸ Ø¨Ø¯Ø£ Ø§Ù„Ù†Ù‡Ø§Ø± ${dayCount}`);

        dayVotes = {};
        players.forEach(p => { if(p.isAlive) dayVotes[p.id] = 0; });
        turnIndex = 0;

        handleDayStartEvent();

        roomTransition(null, `â˜€ï¸ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø³Ø§Ø­Ø© Ø§Ù„ØªØµÙˆÙŠØª ${dayCount}`, () => {
            showScreen('rotation-screen');

            let time = 180;
            if(currentEvent && currentEvent.id === 'rush') time = 90;

            startVoteTimer(time);
            prepareNextTurn();
        });
    }

    function prepareNextTurn() {
        while (turnIndex < players.length && !players[turnIndex].isAlive) {
            turnIndex++;
        }
        if (turnIndex >= players.length) {
            if (phase === 'night') finishNight();
            else if (phase === 'day') finishDayVoting();
            else if (phase === 'confirmation') finishConfirmationVote();
            return;
        }
        activePlayer = players[turnIndex];
        selectedPlayerId = null;
        document.getElementById('turn-wait-view').classList.remove('hidden');
        document.getElementById('turn-action-view').classList.add('hidden');

        document.getElementById('turn-player-name').innerText = activePlayer.name;
        document.getElementById('turn-player-avatar').src = activePlayer.avatar;

        if (phase === 'night') setRoleMood(activePlayer.role, 'night');
        else if (phase === 'day') setRoleMood(activePlayer.role, 'day');
        else if (phase === 'confirmation') setRoleMood(null, null);
    }

    function startTurn() {
        document.getElementById('turn-wait-view').classList.add('hidden');
        document.getElementById('turn-action-view').classList.remove('hidden');
        const title = document.getElementById('action-role-title');
        const instr = document.getElementById('action-instruction');
        const btn = document.getElementById('confirm-action-btn');
        const grid = document.getElementById('action-grid');
        const binaryBtns = document.getElementById('binary-vote-buttons');

        grid.classList.remove('hidden');
        binaryBtns.classList.add('hidden');
        btn.classList.remove('hidden');
        title.style.color = getRoleColor(activePlayer.role);

        if (phase === 'night') {
            renderGrid(true);
            if (activePlayer.role === 'Ù…Ø§ÙÙŠØ§') {
                title.innerText = "Ø£Ù†Øª Ù…Ø§ÙÙŠØ§ ğŸ˜ˆ";
                instr.innerText = "Ø§Ø®ØªØ± Ø§Ù„Ø¶Ø­ÙŠØ©..";
                btn.className = "btn-red";
            } else if (activePlayer.role === 'Ø·Ø¨ÙŠØ¨') {
                title.innerText = "Ø£Ù†Øª Ø·Ø¨ÙŠØ¨ ğŸ©º";
                instr.innerText = "Ø§Ø®ØªØ± Ù…Ù† ØªØ±ÙŠØ¯ Ø¥Ù†Ù‚Ø§Ø°Ù‡.";
                btn.className = "btn-green";
            } else if (activePlayer.role === 'Ù…Ø­Ù‚Ù‚') {
                title.innerText = "Ø£Ù†Øª Ù…Ø­Ù‚Ù‚ ğŸ•µï¸â€â™‚ï¸";
                instr.innerText = "Ø§Ø®ØªØ± Ù…Ø´ØªØ¨Ù‡Ø§Ù‹ Ø¨Ù‡.";
                btn.className = "btn-outline";
            } else if (activePlayer.role === 'Ù‚Ù†Ù‘Ø§Øµ') {
                const bulletsLeft = sniperBullets[activePlayer.id] || 0;
                title.innerText = "Ø£Ù†Øª Ù‚Ù†Ù‘Ø§Øµ ğŸ¯";
                if (bulletsLeft > 0) {
                    const txt = bulletsLeft === 1
                        ? 'Ù„Ø¯ÙŠÙƒ Ø·Ù„Ù‚Ø© ÙˆØ§Ø­Ø¯Ø©ØŒ Ø§Ø®ØªØ± Ù‡Ø¯ÙÙƒ Ø¨Ø­Ø°Ø± Ø£Ùˆ Ø§Ø®ØªØ± Ø¹Ø¯Ù… Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚.'
                        : `Ù„Ø¯ÙŠÙƒ ${bulletsLeft} Ø·Ù„Ù‚Ø§ØªØŒ Ø§Ø®ØªØ± Ø£Ù‡Ø¯Ø§ÙÙƒ Ø¨Ø­Ø°Ø± Ø£Ùˆ Ø§Ø®ØªØ± Ø¹Ø¯Ù… Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚.`;
                    instr.innerText = txt;
                    btn.className = "btn-red";
                    renderGrid(true);
                } else {
                    instr.innerText = "Ø§Ø³ØªØ®Ø¯Ù…Øª ÙƒÙ„ Ø·Ù„Ù‚Ø§ØªÙƒØŒ Ø§Ù†ØªØ¸Ø± Ø¨ØµÙ…Øª Ù‡Ø°Ù‡ Ø§Ù„Ù„ÙŠÙ„Ø©.";
                    btn.className = "btn-outline";
                    renderGrid(false);
                }
            } else {
                if (activePlayer.role === 'Ù…Ù‡Ø±Ø¬') title.innerText = "Ø£Ù†Øª Ù…Ù‡Ø±Ø¬ ğŸƒ";
                else if (activePlayer.role === 'Ø¹Ù…Ø¯Ø©') title.innerText = "Ø£Ù†Øª Ø¹Ù…Ø¯Ø© ğŸ©";
                else title.innerText = "Ø£Ù†Øª Ù…ÙˆØ§Ø·Ù† ğŸ˜´";

                instr.innerText = "ØªØ¸Ø§Ù‡Ø± Ø¨Ø£Ù†Ùƒ ØªÙ„Ø¹Ø¨...";
                renderGrid(false);
                btn.className = "btn-outline";
            }
        }
        else if (phase === 'day') {
            title.innerText = "ğŸ—³ï¸ Ø§Ù„ØªØµÙˆÙŠØª";
            if (activePlayer.role === 'Ø¹Ù…Ø¯Ø©') {
                instr.innerText = "Ø£Ù†Øª Ø§Ù„Ø¹Ù…Ø¯Ø©! ØµÙˆØªÙƒ ÙŠØ­Ø³Ø¨ Ø¨ØµÙˆØªÙŠÙ†.";
            } else {
                instr.innerText = "Ù…Ù† ØªØ´Ùƒ Ø£Ù†Ù‡ Ø§Ù„Ù…Ø§ÙÙŠØ§ØŸ";
            }
            renderGrid(true);
            btn.className = "btn-red";
        }
        else if (phase === 'confirmation') {
            title.innerText = "âš–ï¸ Ø§Ù„Ø­ÙƒÙ…";
            instr.innerText = `Ù‡Ù„ Ù†Ø¹Ø¯Ù… ${players[defendantId].name}ØŸ`;
            grid.classList.add('hidden');
            btn.classList.add('hidden');
            binaryBtns.classList.remove('hidden');
            setRoleMood(null, null);
        }
    }

    function confirmTurnAction() {
        if ((phase === 'day' ||
            (phase === 'night' && ['Ù…Ø§ÙÙŠØ§','Ø·Ø¨ÙŠØ¨','Ù…Ø­Ù‚Ù‚'].includes(activePlayer.role)))
            && selectedPlayerId === null) {

            if (phase === 'night' && !['Ù…Ø§ÙÙŠØ§','Ø·Ø¨ÙŠØ¨','Ù…Ø­Ù‚Ù‚'].includes(activePlayer.role)) {
            } else {
                showModal("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù„Ø§Ø¹Ø¨ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©!", "error");
                return;
            }
        }

        if (phase === 'night') {
            if (activePlayer.role === 'Ù…Ø§ÙÙŠØ§') {
                if (players[selectedPlayerId].role === 'Ù…Ø§ÙÙŠØ§') {
                    showModal("Ø®ÙŠØ§Ù†Ø©ØŸ", "Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ù‚ØªÙ„ Ø²Ù…ÙŠÙ„Ùƒ ÙÙŠ Ø§Ù„Ù…Ø§ÙÙŠØ§!", "error");
                    return;
                }
                nightActions.mafiaTarget = selectedPlayerId;
            }
            else if (activePlayer.role === 'Ø·Ø¨ÙŠØ¨') {
                nightActions.doctorTarget = selectedPlayerId;
            }
            else if (activePlayer.role === 'Ù…Ø­Ù‚Ù‚') {
                if (selectedPlayerId === activePlayer.id) {
                    showModal("Ø®Ø·Ø£", "Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ù‚ÙŠÙ‚ Ù…Ø¹ Ù†ÙØ³Ùƒ!", "error");
                    return;
                }
                const isMafia = players[selectedPlayerId].role === 'Ù…Ø§ÙÙŠØ§';
                const txt = isMafia ? "<span style='color:red'>Ù…Ø§ÙÙŠØ§ ğŸ˜ˆ</span>" : "<span style='color:green'>Ø¨Ø±ÙŠØ¡ âœ…</span>";
                showModal("Ù…Ù„Ù Ø§Ù„ØªØ­Ù‚ÙŠÙ‚", `Ø§Ù„Ù„Ø§Ø¹Ø¨ <b>${players[selectedPlayerId].name}</b> Ù‡Ùˆ: ${txt}`, "info");
            }
            else if (activePlayer.role === 'Ù‚Ù†Ù‘Ø§Øµ') {
    const bulletsLeft = sniperBullets[activePlayer.id] || 0;

    if (bulletsLeft > 0) {
        if (selectedPlayerId === -1) {
            // Ù„Ø§ Ù†Ø°ÙƒØ± Ø§Ù„Ù‚Ù†Ù‘Ø§Øµ ÙˆÙ„Ø§ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨
            addLog("ğŸ¯ Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ÙŠ Ø·Ù„Ù‚Ø© Ø®Ø§ØµØ© Ù‡Ø°Ù‡ Ø§Ù„Ù„ÙŠÙ„Ø©.");
        } else {
            if (selectedPlayerId === null) {
                showModal("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø¯Ù Ø£Ùˆ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¯Ù… Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚!", "error");
                return;
            }
            if (selectedPlayerId === activePlayer.id) {
                showModal("Ø®Ø·Ø£", "Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù†Ø§Ø± Ø¹Ù„Ù‰ Ù†ÙØ³Ùƒ!", "error");
                return;
            }
            nightActions.sniperShots.push({
                sniperId: activePlayer.id,
                targetId: selectedPlayerId
            });
            sniperBullets[activePlayer.id] = bulletsLeft - 1;
            // Ù„Ø§ Ù†ÙƒØ´Ù Ù…Ù† Ø£Ø·Ù„Ù‚ØŒ ÙÙ‚Ø· Ø£Ù† Ù‡Ù†Ø§Ùƒ Ø¥Ø·Ù„Ø§Ù‚ Ù†Ø§Ø±
            addLog("ğŸ¯ Ø³ÙÙ…ÙØ¹ ØµÙˆØª Ø¥Ø·Ù„Ø§Ù‚ Ù†Ø§Ø± Ù‡Ø°Ù‡ Ø§Ù„Ù„ÙŠÙ„Ø©.");
        }
    }
}

        }
        else if (phase === 'day') {
            let voteWeight = (activePlayer.role === 'Ø¹Ù…Ø¯Ø©') ? 2 : 1;
            dayVotes[selectedPlayerId] += voteWeight;
        }

        turnIndex++;
        prepareNextTurn();
    }

    function submitBinaryVote(isYes) {
        if (isYes) confirmationVotes.yes++; else confirmationVotes.no++;
        turnIndex++;
        prepareNextTurn();
    }

    function startDefenseTimer(duration = 20) {
        const ring = document.getElementById('defense-timer-ring');
        const text = document.getElementById('defense-timer-text');
        if (!ring || !text) return;

        if (defenseTimerInterval) {
            clearInterval(defenseTimerInterval);
            defenseTimerInterval = null;
        }

        let remaining = duration;
        ring.style.setProperty('--timer-progress', 1);
        ring.style.setProperty('--timer-color', '#22c55e');
        text.textContent = remaining;

        defenseTimerInterval = setInterval(() => {
            remaining--;
            const progress = Math.max(remaining, 0) / duration;
            ring.style.setProperty('--timer-progress', progress);
            const color = progress < 0.25 ? '#ef4444' : (progress < 0.6 ? '#f59e0b' : '#22c55e');
            ring.style.setProperty('--timer-color', color);
            text.textContent = Math.max(remaining, 0);

            if (remaining <= 0) {
                clearInterval(defenseTimerInterval);
                defenseTimerInterval = null;
            }
        }, 1000);
    }

    function startConfirmationPhase() {
        if (defenseTimerInterval) {
            clearInterval(defenseTimerInterval);
            defenseTimerInterval = null;
        }

        phase = 'confirmation';
        confirmationVotes = { yes: 0, no: 0 };
        turnIndex = 0;

        roomTransition(null, "âš–ï¸ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØªØµÙˆÙŠØª Ø¹Ù„Ù‰ Ø§Ù„Ø­ÙƒÙ…", () => {
            showScreen('rotation-screen');

            const phaseTitle = document.getElementById('phase-title');
            if (phaseTitle) {
                phaseTitle.innerText = "âš–ï¸ Ø§Ù„ØªØµÙˆÙŠØª Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ù…";
            }

            const eventBanner = document.getElementById('event-banner');
            if (eventBanner) eventBanner.style.display = 'none';

            const voteBar = document.getElementById('vote-timer-bar');
            if (voteBar) voteBar.classList.add('hidden');

            setRoleMood(null, null);

            prepareNextTurn();
        });

        addLog(`âš–ï¸ Ø¨Ø¯Ø£ Ø§Ù„ØªØµÙˆÙŠØª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªÙ‡Ù…: ${players[defendantId].name}.`);
    }

    function finishNight() {
        let victim = nightActions.mafiaTarget;
        let saved = nightActions.doctorTarget;
        let messages = [];

      if (victim !== null) {
    if (victim === saved) {
        messages.push(`<h2 style='color:#08d9d6'>âœ¨ ØªÙ… Ø§Ù„Ø¥Ù†Ù‚Ø§Ø°!</h2>Ø­Ø§ÙˆÙ„Øª Ø§Ù„Ù…Ø§ÙÙŠØ§ Ù‚ØªÙ„ <b>${players[victim].name}</b> Ù„ÙƒÙ† Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø£Ù†Ù‚Ø°Ù‡.`);
        // Ù„Ø§ Ù†Ø°ÙƒØ± Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙÙŠ Ù…ÙˆØ¬Ø² Ø§Ù„Ø£Ø®Ø¨Ø§Ø± / Ø§Ù„Ø³Ø¬Ù„
        addLog(`âœ¨ Ù†Ø¬Ø§ ${players[victim].name} Ù…Ù† Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚ØªÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù„ÙŠÙ„Ø©.`);
    } else {
        killPlayer(victim);
        messages.push(`<h2 style='color:#ff2e63'>ğŸ’€ Ø¬Ø±ÙŠÙ…Ø© Ù‚ØªÙ„!</h2>Ø§ØºØªØ§Ù„Øª Ø§Ù„Ù…Ø§ÙÙŠØ§: <b>${players[victim].name}</b>`);
        // Ø¨Ø¯ÙˆÙ† Ø°ÙƒØ± "Ù…Ø§ÙÙŠØ§" ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
        addLog(`ğŸ’€ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${players[victim].name} Ù…ÙŠØªØ§Ù‹ ÙÙŠ Ø§Ù„ØµØ¨Ø§Ø­.`);
    }
}
else {
            messages.push("<h2>ğŸŒ™ Ù‡Ø¯ÙˆØ¡ ØªØ§Ù…</h2>Ù…Ø± Ø§Ù„Ù„ÙŠÙ„ Ø¨Ø³Ù„Ø§Ù… Ù…Ù† Ø¬Ù‡Ø© Ø§Ù„Ù…Ø§ÙÙŠØ§.");
        }
if (nightActions.sniperShots && nightActions.sniperShots.length > 0) {
    nightActions.sniperShots.forEach(shot => {
        const sniper = players[shot.sniperId];
        const target = players[shot.targetId];
        if (!sniper || !sniper.isAlive) return;
        if (!target) return;

        if (target.role === 'Ù…Ø§ÙÙŠØ§') {
            if (target.isAlive) {
                killPlayer(target.id);
                messages.push(`ğŸ¯ Ø§Ù„Ù‚Ù†Ù‘Ø§Øµ Ù‚Ù†Øµ Ø£Ø­Ø¯ Ø£ÙØ±Ø§Ø¯ Ø§Ù„Ù…Ø§ÙÙŠØ§: <b>${target.name}</b>.`);
                // Ù„Ø§ Ù†Ø°ÙƒØ± Ù…Ù† Ø£Ø·Ù„Ù‚ ÙˆÙ„Ø§ Ø¯ÙˆØ± Ø§Ù„Ù‡Ø¯Ù ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
                addLog(`ğŸ¯ ØªÙ… Ø§Ù„Ù‚Ø¶Ø§Ø¡ Ø¹Ù„Ù‰ ${target.name} ÙÙŠ Ù‡Ø¬ÙˆÙ… Ù„ÙŠÙ„ÙŠ.`);
            }
        } else {
            if (target.isAlive) {
                killPlayer(target.id);
            }
            if (sniper.isAlive) {
                killPlayer(sniper.id);
            }
            messages.push(`ğŸ’¥ Ø§Ù„Ù‚Ù†Ù‘Ø§Øµ Ù‚ØªÙ„ <b>${target.name}</b> (Ù„ÙŠØ³ Ù…Ø§ÙÙŠØ§)ØŒ ÙˆÙ…Ø§Øª Ù…Ø¹ Ø¶Ø­ÙŠØªÙ‡ (${sniper.name}).`);
            // Ù„Ø§ Ù†Ø°ÙƒØ± Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆÙ„Ø§ Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Øµ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
            addLog(`ğŸ’¥ ØªÙˆÙÙŠ ${target.name} ÙˆÙ…Ø¹Ù‡ Ù„Ø§Ø¹Ø¨ Ø¢Ø®Ø± ÙÙŠ Ø­Ø§Ø¯Ø« Ù„ÙŠÙ„ÙŠ ØºØ§Ù…Ø¶.`);
        }
    });
}


        const msg = messages.join("<br><br>");

        let winMsg = checkWin();
        if (winMsg) {
            addLog("ğŸ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©.");
            showResultsHTML("Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø©", msg + "<br><br>" + winMsg, null);
        } else {
            showResultsHTML("ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµØ¨Ø§Ø­", msg, startDay);
        }
    }

    function finishDayVoting() {
        stopVoteTimer(true);

        let maxVotes = 0;
        let candidates = [];

        for (let id in dayVotes) {
            let count = dayVotes[id];
            if (count > 0) {
                if (count > maxVotes) { maxVotes = count; candidates = [id]; }
                else if (count === maxVotes) candidates.push(id);
            }
        }

        if (maxVotes === 0) {
            showDecisionScreen("Ø³Ù„Ø¨ÙŠØ©", "Ù„Ù… ÙŠØµÙˆØª Ø£Ø­Ø¯.", "");
            addLog("ğŸ—£ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØµÙˆÙŠØª Ø¹Ù„Ù‰ Ø£Ø­Ø¯.");
            return;
        }
        else if (candidates.length > 1) {
            let names = candidates.map(id => players[id].name).join(" Ùˆ ");
            showDecisionScreen("ØªØ¹Ø§Ø¯Ù„", `ØªØ¹Ø§Ø¯Ù„Øª Ø§Ù„Ø£ØµÙˆØ§Øª Ø¨ÙŠÙ†: <b>${names}</b>`, "");
            addLog(`âš–ï¸ ØªØ¹Ø§Ø¯Ù„ ÙÙŠ Ø§Ù„ØªØµÙˆÙŠØª Ø¨ÙŠÙ† ${names}.`);
            return;
        }

        defendantId = candidates[0];
        roomTransition(null, "âš–ï¸ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØºØ±ÙØ© Ø§Ù„Ù…Ø­Ø§ÙƒÙ…Ø©", () => {
            showScreen('defense-screen');
            document.getElementById('defendant-name').innerText = players[defendantId].name;
            document.getElementById('defendant-avatar').src = players[defendantId].avatar;
            startDefenseTimer(20);
        });
        addLog(`âš–ï¸ ØªÙ… Ø§ØªÙ‡Ø§Ù… ${players[defendantId].name} ÙˆØªØ­ÙˆÙŠÙ„Ù‡ Ù„Ù„Ù…Ø­Ø§ÙƒÙ…Ø©.`);
    }

    function finishConfirmationVote() {
        let yes = confirmationVotes.yes;
        let no = confirmationVotes.no;
        let resultHtml = `
            <div style="display:flex; justify-content:space-around; font-size:1.2rem; margin-bottom:20px;">
                <span style="color:#ff2e63">â˜ ï¸ ${yes}</span>
                <span style="color:#08d9d6">ğŸ›¡ï¸ ${no}</span>
            </div>`;

        if (yes > no) {
            if (players[defendantId].role === 'Ù…Ù‡Ø±Ø¬') {
                applyEndingMood('jester');
                resultHtml += `
                    <div class="end-banner end-banner--jester">
                        <div class="end-banner__icon">ğŸ¤¡</div>
                        <div class="end-banner__title">Ø§Ù†ØªØµØ§Ø± Ø§Ù„Ù…Ù‡Ø±Ø¬</div>
                        <div class="end-banner__text">
                            ØªÙ… Ø¥Ø¹Ø¯Ø§Ù… <b>${players[defendantId].name}</b> ÙˆÙ‡Ø°Ø§ Ø¨Ø§Ù„Ø¶Ø¨Ø· Ù…Ø§ ÙƒØ§Ù† ÙŠØ±ÙŠØ¯Ù‡!<br>
                            Ø§Ù„Ù…Ù‡Ø±Ø¬ Ø®Ø¯Ø¹ Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙˆØ±Ø¨Ø­ Ø§Ù„Ù„Ø¹Ø¨Ø©.
                        </div>
                    </div>`;
                addLog(`ğŸƒ ØªÙ… Ø¥Ø¹Ø¯Ø§Ù… Ø§Ù„Ù…Ù‡Ø±Ø¬ (${players[defendantId].name})! Ø§Ù„Ù…Ù‡Ø±Ø¬ ÙØ§Ø².`);
                showResultsHTML("Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø©", resultHtml, null);
                return;
            }

            killPlayer(defendantId);
            resultHtml += `<h2 style='color:#ff2e63'>ØªÙ… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ù…</h2>ØºØ§Ø¯Ø± <b>${players[defendantId].name}</b> Ø§Ù„Ø­ÙŠØ§Ø©.`;
            addLog(`â˜ ï¸ ØªÙ… Ø¥Ø¹Ø¯Ø§Ù… ${players[defendantId].name}.`);

            let winMsg = checkWin();
            if (winMsg) {
                addLog("ğŸ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©.");
                showResultsHTML("Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø©", resultHtml + winMsg, null);
            } else {
                showResultsHTML("Ù‚Ø±Ø§Ø± Ø§Ù„Ù…Ø­ÙƒÙ…Ø©", resultHtml, startNight);
            }

        } else {
            resultHtml += `<h2 style='color:#08d9d6'>Ø¨Ø±Ø§Ø¡Ø©</h2>Ù†Ø¬Ø§ <b>${players[defendantId].name}</b> Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ù….`;
            addLog(`ğŸ›¡ï¸ Ø­ØµÙ„ ${players[defendantId].name} Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±Ø§Ø¡Ø©.`);
            showDecisionScreen("Ø§Ù„Ø¨Ø±Ø§Ø¡Ø©", resultHtml, "Ù…Ø§Ø°Ø§ Ø³ØªÙØ¹Ù„ÙˆÙ† Ø§Ù„Ø¢Ù†ØŸ");
        }
    }

    function applyEndingMood(type) {
        const b = document.body;
        b.classList.remove('ending-active','ending-citizen','ending-mafia','ending-jester');
        if (!type) return;
        b.classList.add('ending-active');
        if (type === 'citizen') b.classList.add('ending-citizen');
        else if (type === 'mafia') b.classList.add('ending-mafia');
        else if (type === 'jester') b.classList.add('ending-jester');
    }

   function showResultsHTML(title, htmlContent, nextAction) {
    setRoleMood(null, null);
    roomTransition(null, `ğŸ“„ ${title}`, () => {
        showScreen('results-screen');
        document.getElementById('results-title').innerText = title;

        const resultsText = document.getElementById('results-text');
        const buttonsContainer = document.getElementById('custom-result-buttons');
        const defBtn = document.getElementById('default-next-btn');

        resultsText.innerHTML = htmlContent;
        buttonsContainer.innerHTML = '';

        renderAllEmojis(resultsText);

        if (nextAction) {
            // Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© (Ù…Ø«Ù„Ø§Ù‹ Ù…Ù† Ù„ÙŠÙ„ Ù„Ù†Ù‡Ø§Ø±)
            defBtn.style.display = 'block';
            defBtn.innerText = "Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸";
            defBtn.onclick = nextAction;
        } else {
            // Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø© ğŸ”š
            defBtn.style.display = 'block';
            defBtn.innerText = "ğŸ” Ø±Ø§ÙˆÙ†Ø¯ Ø¬Ø¯ÙŠØ¯";
            defBtn.onclick = startNewRound;

            // Ø²Ø± Ø¥Ø¶Ø§ÙÙŠ: Ø¨Ø¯Ø§ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Ø®Ø§Ø±Ø¬ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„)
            buttonsContainer.innerHTML = `
                <button class="btn-outline" onclick="fullReset()" style="margin-top:10px;">
                    ğŸ  Ø¨Ø¯Ø§ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                </button>
            `;
        }
    });
}

function startNewRound() {
    // Ø±Ø¬Ù‘Ø¹ ÙƒÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø£Ø­ÙŠØ§Ø¡
    players.forEach(p => {
        p.isAlive = true;
    });

    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    dayCount = 0;
    phase = 'setup';
    turnIndex = 0;
    nightActions = { mafiaTarget: null, doctorTarget: null, sniperShots: [] };
    dayVotes = {};
    confirmationVotes = { yes: 0, no: 0 };
    defendantId = null;
    activePlayer = null;
    selectedPlayerId = null;
    sniperBullets = {};

    setRoleMood(null, null);
    updateEnvironment(true);

    // Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„ÙƒÙ† Ù†ÙˆØ²Ø¹Ù‡Ø§ Ø¹Ø´ÙˆØ§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø¬Ø¯ÙŠØ¯
    roomTransition(null, 'ğŸ® Ø±Ø§ÙˆÙ†Ø¯ Ø¬Ø¯ÙŠØ¯', () => {
        finalizeRolesAndStart(); // Ù†ÙØ³ Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    });
}

// Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Ø®Ø±ÙˆØ¬ ÙˆØ¨Ø¯Ø§ÙŠØ© Ù…Ù† Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø®Ø§Ø±Ø¬ Ø§Ù„Ù„Ø¹Ø¨Ø©)
function fullReset() {
    location.reload();
}


    function showDecisionScreen(title, mainText, subText) {
        setRoleMood(null, null);
        roomTransition(null, "ğŸ“„ " + title, () => {
            showScreen('results-screen');
            document.getElementById('results-title').innerText = title;
            document.getElementById('results-text').innerHTML = mainText + "<br>" + subText;

            document.getElementById('default-next-btn').style.display = 'none';
            document.getElementById('custom-result-buttons').innerHTML = `
                <div style="display:grid; gap:10px; margin-top:20px;">
                    <button class="btn-red" onclick="startDay()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØµÙˆÙŠØª</button>
                    <button class="btn-outline" onclick="startNight()">ğŸŒ™ Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù„ÙŠÙ„</button>
                </div>
            `;
        });
    }

    function renderGrid(clickable) {
        const grid = document.getElementById('action-grid');
        grid.innerHTML = '';

        const isFoggy = (currentEvent && currentEvent.id === 'fog');

        players.forEach(p => {
            const card = document.createElement('div');
            card.className = `player-card ${!p.isAlive ? 'dead' : ''} ${selectedPlayerId === p.id ? 'selected' : ''}`;

            const showVotes = (dayVotes[p.id] > 0 && phase === 'day' && !isFoggy);

            card.innerHTML = `
                <img src="${p.avatar}" alt="avatar">
                <div style="font-weight:bold;">${p.name}</div>
                ${ showVotes ? `<div style="color:var(--mafia-red); font-size:0.8rem;">ğŸ—³ï¸ ${dayVotes[p.id]}</div>` : '' }
            `;

            if (clickable && p.isAlive) {
                card.onclick = () => { selectedPlayerId = p.id; renderGrid(clickable); };
            }
            grid.appendChild(card);
        });

        /* âœ… Ø®ÙŠØ§Ø± Ø¹Ø¯Ù… Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ù„Ù„Ù‚Ù†Ù‘Ø§Øµ */
        if (clickable && phase === 'night' && activePlayer && activePlayer.role === 'Ù‚Ù†Ù‘Ø§Øµ' && (sniperBullets[activePlayer.id] || 0) > 0) {
            const skipCard = document.createElement('div');
            skipCard.className = `player-card ${selectedPlayerId === -1 ? 'selected' : ''}`;
            skipCard.innerHTML = `
                <div style="font-size:2rem; margin-bottom:4px;">ğŸš«</div>
                <div style="font-weight:bold;">Ø¹Ø¯Ù… Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù†Ø§Ø±</div>
                <div style="font-size:0.75rem; opacity:0.7;">Ø§Ù†ØªØ¸Ø§Ø± Ù‡Ø°Ù‡ Ø§Ù„Ù„ÙŠÙ„Ø©</div>
            `;
            skipCard.onclick = () => {
                selectedPlayerId = -1;
                renderGrid(clickable);
            };
            grid.appendChild(skipCard);
        }
    }

    function killPlayer(id) {
        if (!players[id]) return;
        if (players[id].isAlive) {
            players[id].isAlive = false;
            playSfx('kill');
        }
    }

    function checkWin() {
        const mafias = players.filter(p => p.isAlive && p.role === 'Ù…Ø§ÙÙŠØ§').length;
        const others = players.filter(p => p.isAlive && p.role !== 'Ù…Ø§ÙÙŠØ§').length;

        if (mafias === 0) {
            addLog("ğŸ‰ Ø§Ù†ØªØµØ§Ø± Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ†!");
            applyEndingMood('citizen');
            return `
                <div class="end-banner end-banner--citizen">
                    <div class="end-banner__icon">ğŸ›¡ï¸</div>
                    <div class="end-banner__title">Ø§Ù†ØªØµØ§Ø± Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ†</div>
                    <div class="end-banner__text">
                        ØªÙ… Ø§Ù„Ù‚Ø¶Ø§Ø¡ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø£ÙØ±Ø§Ø¯ Ø§Ù„Ù…Ø§ÙÙŠØ§.<br>
                        Ø°ÙƒØ§Ø¤ÙƒÙ… ÙÙŠ Ø§Ù„ØªØµÙˆÙŠØª Ø£Ù†Ù‚Ø° Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©!
                    </div>
                </div>`;
        }

        if (mafias >= others) {
            addLog("ğŸ‘¿ Ø§Ù†ØªØµØ§Ø± Ø§Ù„Ù…Ø§ÙÙŠØ§!");
            applyEndingMood('mafia');
            return `
                <div class="end-banner end-banner--mafia">
                    <div class="end-banner__icon">ğŸ‘¿</div>
                    <div class="end-banner__title">Ø§Ù†ØªØµØ§Ø± Ø§Ù„Ù…Ø§ÙÙŠØ§</div>
                    <div class="end-banner__text">
                        Ø³ÙŠØ·Ø±Øª Ø§Ù„Ù…Ø§ÙÙŠØ§ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©.<br>
                        Ù„Ù… ÙŠØ¹Ø¯ Ù‡Ù†Ø§Ùƒ Ù…Ù† ÙŠÙˆÙ‚ÙÙ‡Ù… ÙÙŠ Ø§Ù„Ø¸Ù„Ø§Ù…...
                    </div>
                </div>`;
        }
        return null;
    }

    function proceedToNextPhase() { }

    function formatVoteTime(totalSeconds){
        totalSeconds = Math.max(0, Math.floor(totalSeconds));
        const m = Math.floor(totalSeconds / 60);
        const s = totalSeconds % 60;
        return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    function updateVoteTimerBar(){
        const textEl = document.getElementById('vote-timer-text');
        if (!textEl) return;
        textEl.textContent = formatVoteTime(voteTimerRemaining);
    }

    function startVoteTimer(seconds = 180){
        const bar = document.getElementById('vote-timer-bar');
        const pauseBtn = document.getElementById('vote-timer-pause-btn');
        if (!bar) return;

        if (voteTimerInterval){
            clearInterval(voteTimerInterval);
            voteTimerInterval = null;
        }

        voteTimerRemaining = seconds;
        voteTimerPaused = false;
        bar.classList.remove('hidden');
        bar.classList.remove('vote-timer-finished');
        if (pauseBtn){
            pauseBtn.textContent = 'â¸ï¸';
            pauseBtn.title = 'Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª';
        }
        updateVoteTimerBar();

        voteTimerInterval = setInterval(() => {
            if (voteTimerPaused) return;
            voteTimerRemaining--;
            if (voteTimerRemaining <= 0){
                voteTimerRemaining = 0;
                updateVoteTimerBar();
                stopVoteTimer(false);
                handleVoteTimerEnd();
            } else {
                updateVoteTimerBar();
            }
        }, 1000);
    }

    function stopVoteTimer(hide = true){
        const bar = document.getElementById('vote-timer-bar');
        if (voteTimerInterval){
            clearInterval(voteTimerInterval);
            voteTimerInterval = null;
        }
        voteTimerPaused = false;
        if (hide && bar){
            bar.classList.add('hidden');
        }
    }

    function toggleVoteTimerPause(){
        if (!document.getElementById('vote-timer-bar')) return;
        if (!voteTimerInterval && voteTimerRemaining <= 0) return;

        voteTimerPaused = !voteTimerPaused;
        const btn = document.getElementById('vote-timer-pause-btn');
        if (btn){
            if (voteTimerPaused){
                btn.textContent = 'â–¶ï¸';
                btn.title = 'Ø§Ø³ØªØ¦Ù†Ø§Ù';
            } else {
                btn.textContent = 'â¸ï¸';
                btn.title = 'Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª';
            }
        }
    }

    function addVoteTime(extraSeconds){
        voteTimerRemaining = Math.max(0, voteTimerRemaining + extraSeconds);
        if (!voteTimerInterval && voteTimerRemaining > 0){
            startVoteTimer(voteTimerRemaining);
            return;
        }
        updateVoteTimerBar();
    }

    function handleVoteTimerEnd(){
        const bar = document.getElementById('vote-timer-bar');
        if (bar){
            bar.classList.add('vote-timer-finished');
        }
        try{
            if (typeof navigator !== 'undefined' && 'vibrate' in navigator){
                navigator.vibrate([300,150,300,150,500]);
            }
        }catch(e){}
    }

    /* Ø¨Ø³ÙŠØ·: Ø±Ù†Ø¯Ø± Ø§Ù„Ù„ÙˆØ¬ ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© */
    function renderLogs() {
        const container = document.getElementById('game-log-list');
        if (!container) return;
        if (gameLogs.length === 0) {
            container.innerHTML = `<div style="text-align:center; color:#777;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø« Ø¨Ø¹Ø¯...</div>`;
            return;
        }
        container.innerHTML = gameLogs.map(log => `
            <div class="log-item">
                <span class="log-time">${log.time}</span>
                <span>${log.text}</span>
            </div>
        `).join('');
        renderAllEmojis(container);
    }
</script>
</body>
</html>
